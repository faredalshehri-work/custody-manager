<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù‡Ø¯</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .login { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; gap: 20px; }
        .login button { padding: 20px 60px; font-size: 20px; background: #4CAF50; color: white; border: none; border-radius: 10px; cursor: pointer; }
        .login button:hover { background: #45a049; }
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px; }
        .card { background: white; padding: 40px; border-radius: 10px; text-align: center; cursor: pointer; box-shadow: 0 2px 10px rgba(0,0,0,0.1); font-size: 24px; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 5px 20px rgba(0,0,0,0.2); transition: all 0.3s; }
        .header { background: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .stats { display: flex; gap: 20px; flex-wrap: wrap; }
        .stat { background: #e3f2fd; padding: 10px 20px; border-radius: 5px; }
        .stat.cleared { background: #c8e6c9; }
        .btn { padding: 10px 20px; background: #2196F3; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .btn:hover { background: #1976D2; }
        .btn-success { background: #4CAF50; }
        .btn-danger { background: #f44336; }
        .custody-list { display: flex; flex-direction: column; gap: 15px; }
        .custody-item { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .custody-item.completed { border-right: 5px solid #4CAF50; background: #f1f8f4; }
        .custody-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .custody-info { font-size: 14px; color: #666; }
        .expense { background: #f9f9f9; padding: 10px; margin: 10px 0; border-radius: 5px; display: flex; justify-content: space-between; }
        input, textarea { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 5px; }
        .form { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab { padding: 10px 20px; background: white; border: none; border-radius: 5px; cursor: pointer; }
        .tab.active { background: #2196F3; color: white; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;
        const supabase = window.supabase.createClient(
            'https://opyuncxyjdqxawddhdjn.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9weXVuY3h5amRxeGF3ZGRoZGpuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyOTkyNjIsImV4cCI6MjA4MTg3NTI2Mn0.BFObQBOTaUCWktaaCGNBbm_UQ98j4GG9QXz_cOywz0M'
        );

        function App() {
            const [user, setUser] = useState(null);
            const [page, setPage] = useState('dashboard');
            const [custodies, setCustodies] = useState([]);
            const [expenses, setExpenses] = useState([]);
            const [tab, setTab] = useState('active');

            useEffect(() => { if(user) loadData(); }, [user, tab]);

            const loadData = async () => {
                const { data: c } = await supabase.from('custodies').select('*').eq('username', user).eq('status', tab).order('date', { ascending: false });
                const { data: e } = await supabase.from('expenses').select('*');
                setCustodies(c || []);
                setExpenses(e || []);
            };

            const addCustody = async (e) => {
                e.preventDefault();
                const form = e.target;
                await supabase.from('custodies').insert({
    username: user, serial: Date.now(), date: form.date.value,
                    amount: parseFloat(form.amount.value), description: form.desc.value, status: 'active'
                });
                form.reset(); loadData();
            };

            const addExpense = async (custodyId, amount, desc) => {
                await supabase.from('expenses').insert({
                    custody_id: custodyId, serial: Date.now(), amount: parseFloat(amount), description: desc
                });
                loadData();
            };

            const clearCustody = async (id) => {
                await supabase.from('custodies').update({ status: 'cleared' }).eq('id', id);
                loadData();
            };

            const getExpenses = (custodyId) => expenses.filter(e => e.custody_id === custodyId);
            const getTotalExpenses = (custodyId) => getExpenses(custodyId).reduce((sum, e) => sum + e.amount, 0);
            const isComplete = (custody) => getTotalExpenses(custody.id) >= custody.amount;

            const stats = {
                activeTotal: custodies.filter(c => c.status === 'active').reduce((s, c) => s + c.amount, 0),
                activeCount: custodies.filter(c => c.status === 'active').length,
                clearedTotal: custodies.filter(c => c.status === 'cleared').reduce((s, c) => s + c.amount, 0),
                clearedCount: custodies.filter(c => c.status === 'cleared').length,
                remaining: custodies.filter(c => c.status === 'active').reduce((s, c) => s + (c.amount - getTotalExpenses(c.id)), 0)
            };

            if (!user) return (
                <div className="login">
                    <h1>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù‡Ø¯</h1>
                    <button onClick={() => setUser('ÙØ±ÙŠØ¯ - Ø¬Ø¯Ø©')}>ÙØ±ÙŠØ¯ - Ø¬Ø¯Ø©</button>
                    <button onClick={() => setUser('ÙŠØ²ÙŠØ¯ - Ø§Ù„Ø±ÙŠØ§Ø¶')}>ÙŠØ²ÙŠØ¯ - Ø§Ù„Ø±ÙŠØ§Ø¶</button>
                </div>
            );

            if (page === 'dashboard') return (
                <div className="container">
                    <div className="header">
                        <h2>Ù…Ø±Ø­Ø¨Ø§Ù‹ {user}</h2>
                        <button className="btn btn-danger" onClick={() => setUser(null)}>ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
                    </div>
                    <div className="dashboard">
                        <div className="card" onClick={() => setPage('custody')}>ğŸ“‹ Ø§Ù„Ø¹Ù‡Ø¯</div>
                        <div className="card">ğŸ“¦ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</div>
                        <div className="card">ğŸ’° Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø©</div>
                        <div className="card">ğŸ“¨ Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙØ±ÙˆØ¹</div>
                    </div>
                </div>
            );

            return (
                <div className="container">
                    <div className="header">
                        <button className="btn" onClick={() => setPage('dashboard')}>â† Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
                        <h2>Ø§Ù„Ø¹Ù‡Ø¯ - {user}</h2>
                        <div className="stats">
                            <div className="stat">Ù†Ø´Ø·Ø©: {stats.activeCount} ({stats.activeTotal} Ø±.Ø³)</div>
                            <div className="stat cleared">Ù…ØµÙØ§Ø©: {stats.clearedCount} ({stats.clearedTotal} Ø±.Ø³)</div>
                            <div className="stat">Ù…ØªØ¨Ù‚ÙŠ: {stats.remaining.toFixed(2)} Ø±.Ø³</div>
                        </div>
                    </div>

                    <div className="form">
                        <h3>Ø¥Ø¶Ø§ÙØ© Ø¹Ù‡Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>
                        <form onSubmit={addCustody}>
                            <input name="date" type="date" defaultValue={new Date().toISOString().split('T')[0]} required />
                            <input name="amount" type="number" placeholder="Ø§Ù„Ù‚ÙŠÙ…Ø©" required />
                            <input name="desc" placeholder="Ø§Ù„ÙˆØµÙ" required />
                            <button className="btn btn-success" type="submit">Ø¥Ø¶Ø§ÙØ©</button>
                        </form>
                    </div>

                    <div className="tabs">
                        <button className={`tab ${tab === 'active' ? 'active' : ''}`} onClick={() => setTab('active')}>Ø§Ù„Ø¹Ù‡Ø¯ Ø§Ù„Ù†Ø´Ø·Ø©</button>
                        <button className={`tab ${tab === 'cleared' ? 'active' : ''}`} onClick={() => setTab('cleared')}>Ø§Ù„Ø¹Ù‡Ø¯ Ø§Ù„Ù…ØµÙØ§Ø©</button>
                    </div>

                    <div className="custody-list">
                        {custodies.map(custody => {
                            const custodyExpenses = getExpenses(custody.id);
                            const total = getTotalExpenses(custody.id);
                            const complete = isComplete(custody);
                            return (
                                <div key={custody.id} className={`custody-item ${complete ? 'completed' : ''}`}>
                                    <div className="custody-header">
                                        <div>
                                            <strong>#{custody.serial}</strong> - {custody.description}
                                            <div className="custody-info">{custody.date} | {custody.amount} Ø±.Ø³</div>
                                        </div>
                                        <div>
                                            {complete && tab === 'active' && (
                                                <button className="btn btn-success" onClick={() => clearCustody(custody.id)}>ØªØµÙÙŠØ© âœ“</button>
                                            )}
                                            <div style={{marginTop: 5}}>Ø§Ù„Ù…ØµØ±ÙˆÙ: {total.toFixed(2)} | Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: {(custody.amount - total).toFixed(2)}</div>
                                        </div>
                                    </div>

                                    {tab === 'active' && (
                                        <>
                                            <form onSubmit={(e) => {
                                                e.preventDefault();
                                                addExpense(custody.id, e.target.amount.value, e.target.desc.value);
                                                e.target.reset();
                                            }} style={{display: 'flex', gap: 10, marginTop: 10}}>
                                                <input name="amount" type="number" placeholder="Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…ØµØ±ÙˆÙ" required style={{width: '30%'}} />
                                                <input name="desc" placeholder="ÙˆØµÙ Ø§Ù„Ù…ØµØ±ÙˆÙ" required />
                                                <button className="btn" type="submit">Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ</button>
                                            </form>

                                            {custodyExpenses.map(exp => (
                                                <div key={exp.id} className="expense">
                                                    <span>#{exp.serial} - {exp.description}</span>
                                                    <span>{exp.amount} Ø±.Ø³</span>
                                                </div>
                                            ))}
                                        </>
                                    )}
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
