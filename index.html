<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù‡Ø¯</title>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .highlight-expense { animation: highlight 2s ease-in-out; }
        @keyframes highlight {
            0%, 100% { background-color: white; }
            50% { background-color: #fef3c7; }
        }
        .dark .highlight-expense { 
            0%, 100% { background-color: #1e293b; }
            50% { background-color: #3b4253; }
        }
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const supabaseUrl = 'https://opyuncxyjdqxawddhdjn.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9weXVuY3h5amRxeGF3ZGRoZGpuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyOTkyNjIsImV4cCI6MjA4MTg3NTI2Mn0.BFObQBOTaUCWktaaCGNBbm_UQ98j4GG9QXz_cOywz0M';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        const USERS = {
            'Fareed': { password: '0555038099', branch: 'jeddah', branchName: 'ÙØ±Ø¹ Ø¬Ø¯Ø©', role: 'admin' },
            'Yazeed': { password: '0531613949', branch: 'riyadh', branchName: 'ÙØ±Ø¹ Ø§Ù„Ø±ÙŠØ§Ø¶', role: 'admin' },
            'VOLGA': { password: '0550433333', branch: 'all', branchName: 'Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ Ø§Ù„Ø¹Ø§Ù…', role: 'viewer' }
        };

        // Icons
        const Plus = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>;
        const Trash2 = () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>;
        const Edit2 = () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>;
        const Lock = () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>;
        const Unlock = () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></svg>;
        const ChevronUp = () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="18 15 12 9 6 15"/></svg>;
        const ChevronDown = () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="6 9 12 15 18 9"/></svg>;
        const X = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>;
        const Check = () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="20 6 9 17 4 12"/></svg>;
        const Archive = () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="21 8 21 21 3 21 3 8"/><rect x="1" y="3" width="22" height="5"/><line x1="10" y1="12" x2="14" y2="12"/></svg>;
        const BarChart = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="20" x2="12" y2="10"/><line x1="18" y1="20" x2="18" y2="4"/><line x1="6" y1="20" x2="6" y2="16"/></svg>;
        const Settings = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>;
        const Search = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>;
        const Undo = () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 7v6h6"/><path d="M21 17a9 9 0 00-9-9 9 9 0 00-6 2.3L3 13"/></svg>;
        const Redo = () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 7v6h-6"/><path d="M3 17a9 9 0 019-9 9 9 0 016 2.3l3 2.7"/></svg>;
        const Moon = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>;
        const Sun = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>;
        const LogOut = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>;

        const LoginScreen = ({ onLogin }) => {
            const [selectedUser, setSelectedUser] = useState(null);
const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [showPassword, setShowPassword] = useState(false);

            const handleLogin = () => {
    if (!selectedUser) {
        setError('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø³ØªØ®Ø¯Ù…');
        return;
    }
    const user = USERS[selectedUser];
                if (user && user.password === password) {
                    onLogin(username, user);
                } else {
                    setError('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
                }
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-slate-100 flex items-center justify-center p-4">
                    <div className="bg-white rounded-3xl shadow-2xl p-8 md:p-12 w-full max-w-md">
                        <div className="text-center mb-8">
                            <div className="w-20 h-20 bg-blue-600 rounded-2xl mx-auto mb-4 flex items-center justify-center">
                                <Archive />
                            </div>
                            <h1 className="text-3xl font-black text-slate-800 mb-2">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù‡Ø¯</h1>
                            <p className="text-slate-500">Custody Management System</p>
                        </div>
                        
                        {error && (
                            <div className="bg-red-50 border-r-4 border-red-500 text-red-700 p-4 rounded-lg mb-4">
                                {error}
                            </div>
                        )}

                        <div className="space-y-4">
    {!selectedUser ? (
        // Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        <div className="space-y-3">
            <h3 className="text-center text-lg font-bold text-slate-700 mb-4">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</h3>
            
            <button
                onClick={() => setSelectedUser('Fareed')}
                className="w-full p-4 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-xl font-bold hover:from-blue-600 hover:to-blue-700 transition shadow-lg hover:shadow-xl flex items-center justify-between"
            >
                <span className="text-lg">ğŸ‘¤ ÙØ±ÙŠØ¯</span>
                <span className="text-sm opacity-80">ÙØ±Ø¹ Ø¬Ø¯Ø©</span>
            </button>

            <button
                onClick={() => setSelectedUser('Yazeed')}
                className="w-full p-4 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-xl font-bold hover:from-green-600 hover:to-green-700 transition shadow-lg hover:shadow-xl flex items-center justify-between"
            >
                <span className="text-lg">ğŸ‘¤ ÙŠØ²ÙŠØ¯</span>
                <span className="text-sm opacity-80">ÙØ±Ø¹ Ø§Ù„Ø±ÙŠØ§Ø¶</span>
            </button>

            <button
                onClick={() => setSelectedUser('VOLGA')}
                className="w-full p-4 bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-xl font-bold hover:from-purple-600 hover:to-purple-700 transition shadow-lg hover:shadow-xl flex items-center justify-between"
            >
                <span className="text-lg">ğŸ‘¤ VOLGA</span>
                <span className="text-sm opacity-80">Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ Ø§Ù„Ø¹Ø§Ù…</span>
            </button>
        </div>
    ) : (
        // Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
        <div className="space-y-4">
            <div className="text-center mb-4">
                <div className="inline-block px-6 py-3 bg-blue-50 rounded-full mb-2">
                    <span className="text-xl font-bold text-blue-700">
                        {selectedUser === 'Fareed' && 'ğŸ‘¤ ÙØ±ÙŠØ¯'}
                        {selectedUser === 'Yazeed' && 'ğŸ‘¤ ÙŠØ²ÙŠØ¯'}
                        {selectedUser === 'VOLGA' && 'ğŸ‘¤ VOLGA'}
                    </span>
                </div>
                <p className="text-sm text-slate-600">
                    {selectedUser === 'Fareed' && 'ÙØ±Ø¹ Ø¬Ø¯Ø©'}
                    {selectedUser === 'Yazeed' && 'ÙØ±Ø¹ Ø§Ù„Ø±ÙŠØ§Ø¶'}
                    {selectedUser === 'VOLGA' && 'Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ Ø§Ù„Ø¹Ø§Ù…'}
                </p>
            </div>

            <div>
                <label className="block text-sm font-bold text-slate-700 mb-2">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                <div className="relative">
                    <input
                        type={showPassword ? "text" : "password"}
                        value={password}
                        onChange={(e) => setPassword(e.target.value)}
                        onKeyPress={(e) => e.key === 'Enter' && handleLogin()}
                        className="w-full px-4 py-3 pr-12 border-2 border-slate-200 rounded-xl focus:ring-4 focus:ring-blue-100 focus:border-blue-500 outline-none transition"
                        placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"
                        autoFocus
                    />
                    <button
                        type="button"
                        onClick={() => setShowPassword(!showPassword)}
                        className="absolute left-3 top-1/2 -translate-y-1/2 text-2xl"
                    >
                        {showPassword ? 'ğŸ™ˆ' : 'ğŸ‘ï¸'}
                    </button>
                </div>
            </div>

            <div className="flex gap-2">
                <button
                    onClick={() => {
                        setSelectedUser(null);
                        setPassword('');
                        setError('');
                    }}
                    className="flex-1 bg-slate-200 text-slate-700 py-3 rounded-xl font-bold hover:bg-slate-300 transition"
                >
                    Ø±Ø¬ÙˆØ¹
                </button>
                <button
                    onClick={handleLogin}
                    className="flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 transition shadow-lg hover:shadow-xl"
                >
                    Ø¯Ø®ÙˆÙ„
                </button>
            </div>
        </div>
    )}
</div>

                            <div>
                                <label className="block text-sm font-bold text-slate-700 mb-2">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                                <div className="relative">
    <input
        type={showPassword ? "text" : "password"}
        value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    onKeyPress={(e) => e.key === 'Enter' && handleLogin()}
                                    className="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:ring-4 focus:ring-blue-100 focus:border-blue-500 outline-none transition"
                                    placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"
className="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:ring-4 focus:ring-blue-100 focus:border-blue-500 outline-none transition"
/>
<button
    type="button"
    onClick={() => setShowPassword(!showPassword)}
    className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500 hover:text-slate-700"
>
    {showPassword ? 'ğŸ™ˆ' : 'ğŸ‘ï¸'}
</button>
</div>
                            </div>

                            <button
                                onClick={handleLogin}
                                className="w-full bg-blue-600 text-white py-4 rounded-xl font-bold hover:bg-blue-700 transition shadow-lg hover:shadow-xl"
                            >
                                ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const CustodyManager = () => {
            const [currentUser, setCurrentUser] = useState(null);
            const [userInfo, setUserInfo] = useState(null);
            const [darkMode, setDarkMode] = useState(false);
            const [custodies, setCustodies] = useState([]);
            const [clearedCustodies, setClearedCustodies] = useState([]);
            const [predefinedExpenses, setPredefinedExpenses] = useState([]);
            const [history, setHistory] = useState([]);
            const [historyIndex, setHistoryIndex] = useState(-1);
            const [custodySequence, setCustodySequence] = useState(1);
            const [expenseSequence, setExpenseSequence] = useState(1);
            const [mainTab, setMainTab] = useState('custodies');
            const [activeTab, setActiveTab] = useState('active');
            const [sortBy, setSortBy] = useState('newest');
            const [selectedIds, setSelectedIds] = useState([]);
            const [editingId, setEditingId] = useState(null);
            const [globalLock, setGlobalLock] = useState(false);
            const [newCustody, setNewCustody] = useState({ name: '', amount: '', date: new Date().toISOString().split('T')[0] });
            const [expandedExpenses, setExpandedExpenses] = useState({});
            const [newPredefined, setNewPredefined] = useState({ name: '', fixedPrice: '', hasFixedPrice: false });
            const [editingPredefinedId, setEditingPredefinedId] = useState(null);
            const [selectedExpenseType, setSelectedExpenseType] = useState('');
            const [reportPeriod, setReportPeriod] = useState('month');
            const [customStartDate, setCustomStartDate] = useState('');
            const [customEndDate, setCustomEndDate] = useState('');
            const [searchCustody, setSearchCustody] = useState('');
            const [searchExpense, setSearchExpense] = useState('');
            const [highlightedExpense, setHighlightedExpense] = useState(null);
            const [isLoading, setIsLoading] = useState(true);
            const [isSaving, setIsSaving] = useState(false);
            const [lastSaved, setLastSaved] = useState(null);
            
            const expenseRefs = useRef({});

            useEffect(() => {
                if (darkMode) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            }, [darkMode]);

            useEffect(() => {
                if (currentUser) {
                    loadFromSupabase();
                }
            }, [currentUser]);

            const loadFromSupabase = async () => {
                try {
                    setIsLoading(true);
                    
                    let custodiesQuery = supabase.from('custodies').select('*');
                    
                    if (userInfo.branch !== 'all') {
                        custodiesQuery = custodiesQuery.eq('branch', userInfo.branch);
                    }
                    
                    const { data: custodiesData, error: custodiesError } = await custodiesQuery.order('id', { ascending: true });
                    
                    if (custodiesError) throw custodiesError;
                    
                    if (custodiesData && custodiesData.length > 0) {
                        const active = custodiesData.filter(c => !c.clearedDate);
                        const cleared = custodiesData.filter(c => c.clearedDate);
                        
                        setCustodies(active);
                        setClearedCustodies(cleared);
                        
                        const maxCustodySeq = Math.max(...custodiesData.map(c => c.seqNumber || 0), 0);
                        setCustodySequence(maxCustodySeq + 1);
                        
                        const allExpenses = custodiesData.flatMap(c => c.expenses || []);
                        const maxExpenseSeq = Math.max(...allExpenses.map(e => e.seqNumber || 0), 0);
                        setExpenseSequence(maxExpenseSeq + 1);
                    }
                    
                    let predefinedQuery = supabase.from('predefined_settings').select('*');
                    
                    if (userInfo.branch !== 'all') {
                        predefinedQuery = predefinedQuery.eq('branch', userInfo.branch);
                    }
                    
                    const { data: predefinedData, error: predefinedError } = await predefinedQuery;
                    
                    if (predefinedError) throw predefinedError;
                    
                    if (predefinedData) {
                        setPredefinedExpenses(predefinedData);
                    }
                    
                } catch (error) {
                    console.error('Error loading from Supabase:', error);
                    alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + error.message);
                } finally {
                    setIsLoading(false);
                }
            };

            useEffect(() => {
                if (isLoading || !currentUser) return;
                
                const saveTimer = setTimeout(async () => {
                    await saveToSupabase();
                }, 2000);

                return () => clearTimeout(saveTimer);
            }, [custodies, clearedCustodies, predefinedExpenses]);

            const saveToSupabase = async () => {
                if (userInfo.role === 'viewer') return;
                
                try {
                    setIsSaving(true);
                    
                    const allCustodies = [...custodies, ...clearedCustodies].map(c => ({
                        ...c,
                        branch: c.branch || userInfo.branch
                    }));
                    
                    if (allCustodies.length > 0) {
                        const { error: custodiesError } = await supabase
                            .from('custodies')
                            .upsert(allCustodies, { onConflict: 'id' });
                        
                        if (custodiesError) throw custodiesError;
                    }
                    
                    const branchPredefined = predefinedExpenses.map(p => ({
                        ...p,
                        branch: p.branch || userInfo.branch
                    }));
                    
                    if (branchPredefined.length > 0) {
                        const { error: predefinedError } = await supabase
                            .from('predefined_settings')
                            .upsert(branchPredefined, { onConflict: 'id' });
                        
                        if (predefinedError) throw predefinedError;
                    }
                    
                    setLastSaved(new Date());
                    
                } catch (error) {
                    console.error('Error saving to Supabase:', error);
                } finally {
                    setIsSaving(false);
                }
            };

            useEffect(() => {
                const handleKeyboard = (e) => {
                    if (e.ctrlKey && e.key === 'z') {
                        e.preventDefault();
                        undo();
                    } else if (e.ctrlKey && e.key === 'y') {
                        e.preventDefault();
                        redo();
                    }
                };
                window.addEventListener('keydown', handleKeyboard);
                return () => window.removeEventListener('keydown', handleKeyboard);
            }, [historyIndex, history]);

            const saveToHistory = (newCustodies, newCleared) => {
                const newHistory = history.slice(0, historyIndex + 1);
                newHistory.push({ custodies: JSON.parse(JSON.stringify(newCustodies)), clearedCustodies: JSON.parse(JSON.stringify(newCleared)) });
                if (newHistory.length > 50) newHistory.shift();
                setHistory(newHistory);
                setHistoryIndex(newHistory.length - 1);
            };

            const undo = () => {
                if (historyIndex > 0 && userInfo.role !== 'viewer') {
                    const prevState = history[historyIndex - 1];
                    setCustodies(JSON.parse(JSON.stringify(prevState.custodies)));
                    setClearedCustodies(JSON.parse(JSON.stringify(prevState.clearedCustodies)));
                    setHistoryIndex(historyIndex - 1);
                }
            };

            const redo = () => {
                if (historyIndex < history.length - 1 && userInfo.role !== 'viewer') {
                    const nextState = history[historyIndex + 1];
                    setCustodies(JSON.parse(JSON.stringify(nextState.custodies)));
                    setClearedCustodies(JSON.parse(JSON.stringify(nextState.clearedCustodies)));
                    setHistoryIndex(historyIndex + 1);
                }
            };

            const updateCustodiesWithHistory = (newCustodies) => {
                if (userInfo.role === 'viewer') return;
                setCustodies(newCustodies);
                saveToHistory(newCustodies, clearedCustodies);
            };

            const updateClearedWithHistory = (newCleared) => {
                if (userInfo.role === 'viewer') return;
                setClearedCustodies(newCleared);
                saveToHistory(custodies, newCleared);
            };

            const addCustody = () => {
                if (userInfo.role === 'viewer') return;
                if (!newCustody.name || !newCustody.amount) return;
                const custody = {
                    id: Date.now(),
                    seqNumber: custodySequence,
                    name: newCustody.name,
                    amount: parseFloat(newCustody.amount),
                    date: newCustody.date,
                    branch: userInfo.branch,
                    locked: false,
                    expenses: []
                };
                updateCustodiesWithHistory([...custodies, custody]);
                setCustodySequence(custodySequence + 1);
                setNewCustody({ name: '', amount: '', date: new Date().toISOString().split('T')[0] });
            };

            const deleteCustody = async (id) => {
                if (userInfo.role === 'viewer') return;
                if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù‡Ø¯Ø©ØŸ')) return;
                
                try {
                    const { error } = await supabase.from('custodies').delete().eq('id', id);
                    if (error) throw error;
                    
                    const list = activeTab === 'active' ? custodies : clearedCustodies;
                    const setter = activeTab === 'active' ? updateCustodiesWithHistory : updateClearedWithHistory;
                    setter(list.filter(c => c.id !== id));
                    setSelectedIds(selectedIds.filter(sid => sid !== id));
                } catch (error) {
                    console.error('Error deleting:', error);
                    alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù: ' + error.message);
                }
            };

            const deleteSelected = async () => {
                if (userInfo.role === 'viewer') return;
                if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù ${selectedIds.length} Ø¹Ù‡Ø¯Ø©ØŸ`)) return;
                
                try {
                    const { error } = await supabase.from('custodies').delete().in('id', selectedIds);
                    if (error) throw error;
                    
                    const list = activeTab === 'active' ? custodies : clearedCustodies;
                    const setter = activeTab === 'active' ? updateCustodiesWithHistory : updateClearedWithHistory;
                    setter(list.filter(c => !selectedIds.includes(c.id)));
                    setSelectedIds([]);
                } catch (error) {
                    console.error('Error deleting:', error);
                    alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù: ' + error.message);
                }
            };

            const toggleLock = (id) => {
                if (userInfo.role === 'viewer') return;
                updateCustodiesWithHistory(custodies.map(c => c.id === id ? { ...c, locked: !c.locked } : c));
            };
            
            const toggleGlobalLock = () => {
                if (userInfo.role === 'viewer') return;
                setGlobalLock(!globalLock);
                updateCustodiesWithHistory(custodies.map(c => ({ ...c, locked: !globalLock })));
            };

            const moveCustody = (id, dir) => {
                if (userInfo.role === 'viewer') return;
                const idx = custodies.findIndex(c => c.id === id);
                if (idx === -1) return;
                const newIdx = dir === 'up' ? idx - 1 : idx + 1;
                if (newIdx < 0 || newIdx >= custodies.length) return;
                const arr = [...custodies];
                [arr[idx], arr[newIdx]] = [arr[newIdx], arr[idx]];
                updateCustodiesWithHistory(arr);
            };

            const updateCustody = (id, field, value) => {
                if (userInfo.role === 'viewer') return;
                updateCustodiesWithHistory(custodies.map(c => c.id === id ? { ...c, [field]: value } : c));
            };

            const addExpense = (custodyId, scrollToNew = true) => {
                if (userInfo.role === 'viewer') return;
                const newExpense = {
                    id: Date.now(),
                    seqNumber: expenseSequence,
                    name: '',
                    expenseType: '',
                    amount: '',
                    date: new Date().toISOString().split('T')[0],
                    includeTax: true
                };
                
                updateCustodiesWithHistory(custodies.map(c => c.id === custodyId ? {
                    ...c,
                    expenses: [...c.expenses, newExpense]
                } : c));
                
                setExpenseSequence(expenseSequence + 1);
                setExpandedExpenses({ ...expandedExpenses, [custodyId]: true });
                
                if (scrollToNew) {
                    setTimeout(() => {
                        const expenseEl = expenseRefs.current[`${custodyId}-${newExpense.id}`];
                        if (expenseEl) {
                            expenseEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    }, 100);
                }
            };

            const updateExpense = (custodyId, expenseId, field, value) => {
                if (userInfo.role === 'viewer') return;
                updateCustodiesWithHistory(custodies.map(c => {
                    if (c.id === custodyId) {
                        return {
                            ...c,
                            expenses: c.expenses.map(e => {
                                if (e.id === expenseId) {
                                    if (field === 'expenseType' && value) {
                                        const pred = predefinedExpenses.find(p => p.id === parseInt(value));
                                        if (pred) {
                                            return {
                                                ...e,
                                                expenseType: value,
                                                name: pred.name,
                                                amount: pred.hasFixedPrice ? pred.fixedPrice : e.amount
                                            };
                                        }
                                    }
                                    return { ...e, [field]: value };
                                }
                                return e;
                            })
                        };
                    }
                    return c;
                }));
            };

            const deleteExpense = (custodyId, expenseId) => {
                if (userInfo.role === 'viewer') return;
                if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ØµØ±ÙˆÙØŸ')) return;
                updateCustodiesWithHistory(custodies.map(c => c.id === custodyId ? {
                    ...c,
                    expenses: c.expenses.filter(e => e.id !== expenseId)
                } : c));
            };

            const calcExpenseTotal = (exp) => {
                const amt = parseFloat(exp.amount) || 0;
                return exp.includeTax ? amt : amt * 1.15;
            };

            const calcCustodyExpenses = (custody) => custody.expenses.reduce((s, e) => s + calcExpenseTotal(e), 0);
            const calcRemaining = (custody) => custody.amount - calcCustodyExpenses(custody);

            const clearCustody = (id, withdrawRemaining = false) => {
                if (userInfo.role === 'viewer') return;
                const custody = custodies.find(c => c.id === id);
                if (!custody) return;
                
                let message = 'Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØµÙÙŠØ© Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù‡Ø¯Ø©ØŸ';
                if (withdrawRemaining && calcRemaining(custody) > 0) {
                    message = `Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØµÙÙŠØ© Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù‡Ø¯Ø© ÙˆØ³Ø­Ø¨ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ (${calcRemaining(custody).toFixed(2)} Ø±ÙŠØ§Ù„)ØŸ`;
                }
                
                if (!confirm(message)) return;
                
                updateCustodiesWithHistory(custodies.filter(c => c.id !== id));
                setClearedCustodies([...clearedCustodies, { ...custody, clearedDate: new Date().toISOString() }]);
            };

            const restoreCustody = (id) => {
                if (userInfo.role === 'viewer') return;
                const custody = clearedCustodies.find(c => c.id === id);
                if (!custody) return;
                
                updateClearedWithHistory(clearedCustodies.filter(c => c.id !== id));
                const { clearedDate, ...restored } = custody;
                updateCustodiesWithHistory([...custodies, restored]);
            };

            const getSorted = (list) => {
                const sorted = [...list];
                switch (sortBy) {
                    case 'highest': return sorted.sort((a, b) => b.amount - a.amount);
                    case 'lowest': return sorted.sort((a, b) => a.amount - b.amount);
                    case 'newest': return sorted.sort((a, b) => new Date(b.date) - new Date(a.date));
                    case 'oldest': return sorted.sort((a, b) => new Date(a.date) - new Date(b.date));
                    default: return sorted;
                }
            };

            const addPredefined = () => {
                if (userInfo.role === 'viewer') return;
                if (!newPredefined.name) return;
                setPredefinedExpenses([...predefinedExpenses, {
                    id: Date.now(),
                    name: newPredefined.name,
                    hasFixedPrice: newPredefined.hasFixedPrice,
                    fixedPrice: newPredefined.hasFixedPrice ? parseFloat(newPredefined.fixedPrice) || 0 : 0,
                    branch: userInfo.branch
                }]);
                setNewPredefined({ name: '', fixedPrice: '', hasFixedPrice: false });
            };

            const updatePredefined = (id, field, value) => {
                if (userInfo.role === 'viewer') return;
                setPredefinedExpenses(predefinedExpenses.map(e => e.id === id ? { ...e, [field]: value } : e));
            };

            const deletePredefined = async (id) => {
                if (userInfo.role === 'viewer') return;
                if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„Ù…Ø¹Ø±ÙØŸ')) return;
                
                try {
                    const { error } = await supabase.from('predefined_settings').delete().eq('id', id);
                    if (error) throw error;
                    setPredefinedExpenses(predefinedExpenses.filter(e => e.id !== id));
                } catch (error) {
                    console.error('Error deleting:', error);
                    alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù: ' + error.message);
                }
            };

            const searchForCustody = () => {
                const seqNum = parseInt(searchCustody);
                if (!seqNum) return;
                
                let custody = custodies.find(c => c.seqNumber === seqNum);
                let isCleared = false;
                
                if (!custody) {
                    custody = clearedCustodies.find(c => c.seqNumber === seqNum);
                    isCleared = true;
                }
                
                if (custody) {
                    setMainTab('custodies');
                    setActiveTab(isCleared ? 'cleared' : 'active');
                    setTimeout(() => {
                        const custodyEl = document.getElementById(`custody-${custody.id}`);
                        if (custodyEl) {
                            custodyEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            custodyEl.classList.add('highlight-expense');
                            setTimeout(() => custodyEl.classList.remove('highlight-expense'), 2000);
                        }
                    }, 100);
                } else {
                    alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ù‡Ø¯Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù…');
                }
            };

            const searchForExpense = () => {
                const seqNum = parseInt(searchExpense);
                if (!seqNum) return;
                
                for (const custody of custodies) {
                    const expense = custody.expenses.find(e => e.seqNumber === seqNum);
                    if (expense) {
                        setMainTab('custodies');
                        setActiveTab('active');
                        setExpandedExpenses({ ...expandedExpenses, [custody.id]: true });
                        setHighlightedExpense(`${custody.id}-${expense.id}`);
                        
                        setTimeout(() => {
                            const expenseEl = expenseRefs.current[`${custody.id}-${expense.id}`];
                            if (expenseEl) {
                                expenseEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                expenseEl.classList.add('highlight-expense');
                                setTimeout(() => {
                                    expenseEl.classList.remove('highlight-expense');
                                    setHighlightedExpense(null);
                                }, 2000);
                            }
                        }, 100);
                        return;
                    }
                }
                
                for (const custody of clearedCustodies) {
                    const expense = custody.expenses.find(e => e.seqNumber === seqNum);
                    if (expense) {
                        alert(`Ø§Ù„Ù…ØµØ±ÙˆÙ #${seqNum} Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ø¹Ù‡Ø¯Ø© Ø§Ù„Ù…ØµÙØ§Ø©: ${custody.name} (#${custody.seqNumber})`);
                        setMainTab('custodies');
                        setActiveTab('cleared');
                        setTimeout(() => {
                            const custodyEl = document.getElementById(`custody-${custody.id}`);
                            if (custodyEl) {
                                custodyEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                custodyEl.classList.add('highlight-expense');
                                setTimeout(() => custodyEl.classList.remove('highlight-expense'), 2000);
                            }
                        }, 100);
                        return;
                    }
                }
                
                alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…ØµØ±ÙˆÙ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù…');
            };

            const getDateRange = () => {
                const now = new Date();
                let startDate, endDate = now;
                if (reportPeriod === 'custom') {
                    startDate = customStartDate ? new Date(customStartDate) : new Date(now.getFullYear(), 0, 1);
                    endDate = customEndDate ? new Date(customEndDate) : now;
                } else {
                    const days = { '2days': 2, 'week': 7, 'month': 30, 'year': 365, '2years': 730, '5years': 1825 }[reportPeriod] || 30;
                    startDate = new Date(now.getTime() - (days * 24 * 60 * 60 * 1000));
                }
                return { startDate, endDate };
            };

            const getReportData = () => {
                if (!selectedExpenseType) return null;
                const { startDate, endDate } = getDateRange();
                const selExp = predefinedExpenses.find(e => e.id === parseInt(selectedExpenseType));
                if (!selExp) return null;

                const filtered = [...custodies, ...clearedCustodies].filter(c => {
                    const d = new Date(c.date);
                    return d >= startDate && d <= endDate;
                });

                let total = 0, count = 0;
                filtered.forEach(c => {
                    c.expenses.forEach(e => {
                        if (e.expenseType === selectedExpenseType) {
                            total += calcExpenseTotal(e);
                            count++;
                        }
                    });
                });

                return {
                    expenseName: selExp.name,
                    custodiesCount: filtered.length,
                    custodies: filtered,
                    expenseCount: count,
                    totalExpenses: total,
                    startDate,
                    endDate
                };
            };

            const handleLogout = () => {
                setCurrentUser(null);
                setUserInfo(null);
                setCustodies([]);
                setClearedCustodies([]);
                setPredefinedExpenses([]);
            };

            if (!currentUser) {
                return <LoginScreen onLogin={(username, user) => {
                    setCurrentUser(username);
                    setUserInfo(user);
                }} />;
            }

            const displayList = activeTab === 'active' ? custodies : clearedCustodies;
            const sortedList = getSorted(displayList);
            const totalCustodies = custodies.reduce((s, c) => s + c.amount, 0);
            const totalExpenses = custodies.reduce((s, c) => s + calcCustodyExpenses(c), 0);
            const totalRemaining = totalCustodies - totalExpenses;
            
            const clearedTotalAmount = clearedCustodies.reduce((s, c) => s + c.amount, 0);
            const clearedTotalExpenses = clearedCustodies.reduce((s, c) => s + calcCustodyExpenses(c), 0);
            const clearedTotalRemaining = clearedTotalAmount - clearedTotalExpenses;
            const clearedTotalExpenseCount = clearedCustodies.reduce((s, c) => s + c.expenses.length, 0);
            
            const reportData = mainTab === 'reports' ? getReportData() : null;

            const isReadOnly = userInfo.role === 'viewer';

            return (
                <div className={`min-h-screen ${darkMode ? 'dark bg-slate-900' : 'bg-gradient-to-br from-slate-50 to-slate-100'} transition-colors duration-300`}>
                    {isLoading && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div className="bg-white dark:bg-slate-800 rounded-2xl p-8 flex flex-col items-center gap-4">
                                <div className="loading-spinner"></div>
                                <p className="text-lg font-bold text-slate-800 dark:text-white">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
                            </div>
                        </div>
                    )}

                    <div className="fixed top-2 left-2 md:top-4 md:left-4 z-40 flex flex-col gap-2">
                        {isSaving && (
                            <div className="bg-blue-600 text-white px-3 py-2 md:px-4 rounded-lg shadow-lg flex items-center gap-2 animate-pulse text-sm">
                                <div className="w-2 h-2 bg-white rounded-full animate-ping"></div>
                                Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...
                            </div>
                        )}
                        {!isSaving && lastSaved && (
                            <div className="bg-green-600 text-white px-3 py-2 md:px-4 rounded-lg shadow-lg text-xs md:text-sm">
                                Ø¢Ø®Ø± Ø­ÙØ¸: {lastSaved.toLocaleTimeString('ar-SA')}
                            </div>
                        )}
                    </div>

                    <div className="max-w-7xl mx-auto p-3 md:p-6">
                        {/* Header */}
                        <div className={`${darkMode ? 'bg-slate-800' : 'bg-white'} rounded-2xl shadow-xl p-4 md:p-6 mb-4 md:mb-6`}>
                            <div className="flex flex-col md:flex-row justify-between items-center gap-4">
                                <div className="text-center md:text-right">
                                    <h1 className="text-2xl md:text-4xl font-black text-blue-600 mb-1">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù‡Ø¯</h1>
                                    <p className={`text-xs md:text-sm ${darkMode ? 'text-slate-400' : 'text-slate-500'}`}>Custody Management System</p>
                                </div>
                                
                                <div className={`text-center px-4 md:px-6 py-2 md:py-3 rounded-xl ${darkMode ? 'bg-slate-700' : 'bg-blue-50'}`}>
                                    <div className={`text-xl md:text-3xl font-black ${darkMode ? 'text-blue-400' : 'text-blue-600'}`}>
                                        {userInfo.branchName}
                                    </div>
                                    {isReadOnly && (
                                        <div className="text-xs md:text-sm text-orange-600 font-bold mt-1">ÙˆØ¶Ø¹ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·</div>
                                    )}
                                </div>

                                <div className="flex items-center gap-2">
                                    <button 
                                        onClick={() => setDarkMode(!darkMode)}
                                        className={`p-2 md:p-3 rounded-xl ${darkMode ? 'bg-yellow-400 text-slate-900' : 'bg-slate-700 text-white'} hover:scale-110 transition`}
                                    >
                                        {darkMode ? <Sun /> : <Moon />}
                                    </button>
                                    <button 
                                        onClick={handleLogout}
                                        className="p-2 md:p-3 bg-red-600 text-white rounded-xl hover:bg-red-700 transition flex items-center gap-2"
                                    >
                                        <LogOut />
                                        <span className="hidden md:inline">Ø®Ø±ÙˆØ¬</span>
                                    </button>
                                </div>
                            </div>
                        </div>

                        {/* Search and Undo/Redo Bar */}
                        {!isReadOnly && (
                            <div className={`${darkMode ? 'bg-slate-800' : 'bg-white'} rounded-xl shadow-lg p-3 md:p-4 mb-4 flex flex-wrap gap-2 items-center justify-between`}>
                                <div className="flex gap-2">
                                    <button onClick={undo} disabled={historyIndex <= 0} className={`px-3 py-2 ${darkMode ? 'bg-slate-700' : 'bg-slate-200'} rounded-lg disabled:opacity-30 flex items-center gap-2 text-sm`}>
                                        <Undo /> <span className="hidden md:inline">ØªØ±Ø§Ø¬Ø¹</span>
                                    </button>
                                    <button onClick={redo} disabled={historyIndex >= history.length - 1} className={`px-3 py-2 ${darkMode ? 'bg-slate-700' : 'bg-slate-200'} rounded-lg disabled:opacity-30 flex items-center gap-2 text-sm`}>
                                        <Redo /> <span className="hidden md:inline">Ø¥Ø¹Ø§Ø¯Ø©</span>
                                    </button>
                                </div>
                                
                                <div className="flex flex-wrap gap-2 items-center">
                                    <input type="number" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‡Ø¯Ø©" value={searchCustody} onChange={(e) => setSearchCustody(e.target.value)} className={`w-24 md:w-32 px-2 md:px-3 py-2 border rounded-lg text-sm ${darkMode ? 'bg-slate-700 border-slate-600 text-white' : ''}`} />
                                    <button onClick={searchForCustody} className="px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-1 text-sm">
                                        <Search /> <span className="hidden md:inline">Ø¨Ø­Ø« Ø¹Ù‡Ø¯Ø©</span>
                                    </button>
                                    
                                    <input type="number" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù…ØµØ±ÙˆÙ" value={searchExpense} onChange={(e) => setSearchExpense(e.target.value)} className={`w-24 md:w-32 px-2 md:px-3 py-2 border rounded-lg text-sm ${darkMode ? 'bg-slate-700 border-slate-600 text-white' : ''}`} />
                                    <button onClick={searchForExpense} className="px-3 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 flex items-center gap-1 text-sm">
                                        <Search /> <span className="hidden md:inline">Ø¨Ø­Ø« Ù…ØµØ±ÙˆÙ</span>
                                    </button>
                                </div>
                            </div>
                        )}

                        {/* Main Tabs */}
                        <div className="flex gap-2 md:gap-3 mb-4 md:mb-6 overflow-x-auto">
                            <button onClick={() => setMainTab('custodies')} className={`flex-1 min-w-[100px] px-4 md:px-6 py-2 md:py-3 rounded-xl font-bold transition flex items-center justify-center gap-2 text-sm md:text-base ${mainTab === 'custodies' ? 'bg-blue-600 text-white shadow-xl' : `${darkMode ? 'bg-slate-800 text-slate-300' : 'bg-white text-slate-600'} hover:bg-blue-50`}`}>
                                <Archive /> Ø§Ù„Ø¹Ù‡Ø¯
                            </button>
                            <button onClick={() => setMainTab('reports')} className={`flex-1 min-w-[100px] px-4 md:px-6 py-2 md:py-3 rounded-xl font-bold transition flex items-center justify-center gap-2 text-sm md:text-base ${mainTab === 'reports' ? 'bg-blue-600 text-white shadow-xl' : `${darkMode ? 'bg-slate-800 text-slate-300' : 'bg-white text-slate-600'} hover:bg-blue-50`}`}>
                                <BarChart /> Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
                            </button>
                            <button onClick={() => setMainTab('settings')} className={`flex-1 min-w-[100px] px-4 md:px-6 py-2 md:py-3 rounded-xl font-bold transition flex items-center justify-center gap-2 text-sm md:text-base ${mainTab === 'settings' ? 'bg-blue-600 text-white shadow-xl' : `${darkMode ? 'bg-slate-800 text-slate-300' : 'bg-white text-slate-600'} hover:bg-blue-50`}`}>
                                <Settings /> Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ù…Ø¹Ø±ÙØ©
                            </button>
                        </div>

                        {/* Custodies Tab */}
                        {mainTab === 'custodies' && (
                            <>
                                <div className={`${darkMode ? 'bg-slate-800' : 'bg-white'} rounded-2xl shadow-xl p-4 md:p-6 mb-4 md:mb-6`}>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-3 md:gap-4 mb-4 md:mb-6">
                                        <div className="bg-blue-50 dark:bg-blue-900 rounded-xl p-3 md:p-4 text-center">
                                            <div className="text-xs md:text-sm text-blue-600 dark:text-blue-300 mb-1">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù‡Ø¯</div>
                                            <div className="text-xl md:text-2xl font-bold text-blue-700 dark:text-blue-200">{totalCustodies.toFixed(2)} Ø±ÙŠØ§Ù„</div>
                                        </div>
                                        <div className="bg-red-50 dark:bg-red-900 rounded-xl p-3 md:p-4 text-center">
                                            <div className="text-xs md:text-sm text-red-600 dark:text-red-300 mb-1">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</div>
                                            <div className="text-xl md:text-2xl font-bold text-red-700 dark:text-red-200">{totalExpenses.toFixed(2)} Ø±ÙŠØ§Ù„</div>
                                        </div>
                                        <div className="bg-green-50 dark:bg-green-900 rounded-xl p-3 md:p-4 text-center">
                                            <div className="text-xs md:text-sm text-green-600 dark:text-green-300 mb-1">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</div>
                                            <div className="text-xl md:text-2xl font-bold text-green-700 dark:text-green-200">{totalRemaining.toFixed(2)} Ø±ÙŠØ§Ù„</div>
                                        </div>
                                    </div>

                                    {!isReadOnly && (
                                        <>
                                            <div className="flex flex-col md:flex-row gap-2 mb-4">
                                                <input type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù‡Ø¯Ø©" value={newCustody.name} onChange={(e) => setNewCustody({ ...newCustody, name: e.target.value })} className={`flex-1 px-3 md:px-4 py-2 border rounded-lg text-sm md:text-base ${darkMode ? 'bg-slate-700 border-slate-600 text-white' : 'border-slate-300'}`} />
                                                <input type="number" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" value={newCustody.amount} onChange={(e) => setNewCustody({ ...newCustody, amount: e.target.value })} className={`w-full md:w-32 px-3 md:px-4 py-2 border rounded-lg text-sm md:text-base ${darkMode ? 'bg-slate-700 border-slate-600 text-white' : 'border-slate-300'}`} />
                                                <input type="date" value={newCustody.date} onChange={(e) => setNewCustody({ ...newCustody, date: e.target.value })} className={`w-full md:w-40 px-3 md:px-4 py-2 border rounded-lg text-sm md:text-base ${darkMode ? 'bg-slate-700 border-slate-600 text-white' : 'border-slate-300'}`} />
                                                <button onClick={addCustody} className="w-full md:w-auto px-4 md:px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center justify-center gap-2 text-sm md:text-base">
                                                    <Plus /> Ø¥Ø¶Ø§ÙØ©
                                                </button>
                                            </div>

                                            <div className="flex flex-wrap gap-2">
                                                <select value={sortBy} onChange={(e) => setSortBy(e.target.value)} className={`px-3 md:px-4 py-2 border rounded-lg text-sm ${darkMode ? 'bg-slate-700 border-slate-600 text-white' : 'border-slate-300'}`}>
                                                    <option value="newest">Ø§Ù„Ø£Ø­Ø¯Ø«</option>
                                                    <option value="oldest">Ø§Ù„Ø£Ù‚Ø¯Ù…</option>
                                                    <option value="highest">Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù‚ÙŠÙ…Ø©</option>
                                                    <option value="lowest">Ø§Ù„Ø£Ù‚Ù„ Ù‚ÙŠÙ…Ø©</option>
                                                </select>
                                                <button onClick={toggleGlobalLock} className={`px-3 md:px-4 py-2 rounded-lg flex items-center gap-2 text-sm ${globalLock ? 'bg-red-600 text-white' : `${darkMode ? 'bg-slate-700' : 'bg-slate-200'} ${darkMode ? 'text-white' : 'text-slate-700'}`}`}>
                                                    {globalLock ? <Lock /> : <Unlock />}
                                                    <span className="hidden md:inline">{globalLock ? 'Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù‚ÙÙ„ Ø§Ù„Ø´Ø§Ù…Ù„' : 'Ù‚ÙÙ„ Ø§Ù„ÙƒÙ„'}</span>
                                                </button>
                                                {selectedIds.length > 0 && (
                                                    <button onClick={deleteSelected} className="px-3 md:px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 flex items-center gap-2 text-sm">
                                                        <Trash2 />
                                                        <span className="hidden md:inline">Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø¯Ø¯ ({selectedIds.length})</span>
                                                    </button>
                                                )}
                                            </div>
                                        </>
                                    )}
                                </div>

                                <div className="flex gap-2 mb-4 overflow-x-auto">
                                    <button onClick={() => setActiveTab('active')} className={`flex-1 min-w-[120px] px-4 md:px-6 py-2 md:py-3 rounded-lg font-semibold text-sm md:text-base ${activeTab === 'active' ? `${darkMode ? 'bg-slate-700 text-blue-400' : 'bg-white text-blue-600'} shadow-lg` : `${darkMode ? 'bg-slate-800 text-slate-400' : 'bg-white/50 text-slate-600'}`}`}>
                                        Ø§Ù„Ø¹Ù‡Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠØ© ({custodies.length})
                                    </button>
                                    <button onClick={() => setActiveTab('cleared')} className={`flex-1 min-w-[120px] px-4 md:px-6 py-2 md:py-3 rounded-lg font-semibold text-sm md:text-base ${activeTab === 'cleared' ? `${darkMode ? 'bg-slate-700 text-blue-400' : 'bg-white text-blue-600'} shadow-lg` : `${darkMode ? 'bg-slate-800 text-slate-400' : 'bg-white/50 text-slate-600'}`}`}>
                                        Ø§Ù„Ø¹Ù‡Ø¯ Ø§Ù„Ù…ØµÙØ§Ø© ({clearedCustodies.length})
                                    </button>
                                </div>

                                {activeTab === 'cleared' && clearedCustodies.length > 0 && (
                                    <div className={`${darkMode ? 'bg-slate-800' : 'bg-white'} rounded-xl shadow-lg p-4 md:p-6 mb-4`}>
                                        <h3 className={`text-base md:text-lg font-bold ${darkMode ? 'text-white' : 'text-slate-800'} mb-4`}>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ù‡Ø¯ Ø§Ù„Ù…ØµÙØ§Ø©</h3>
                                        <div className="grid grid-cols-2 md:grid-cols-5 gap-2 md:gap-4">
                                            <div className="bg-blue-50 dark:bg-blue-900 rounded-lg p-2 md:p-3 text-center">
                                                <div className="text-xs text-blue-600 dark:text-blue-300 mb-1">Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù‡Ø¯</div>
                                                <div className="text-lg md:text-xl font-bold text-blue-700 dark:text-blue-200">{clearedCustodies.length}</div>
                                            </div>
                                            <div className="bg-purple-50 dark:bg-purple-900 rounded-lg p-2 md:p-3 text-center">
                                                <div className="text-xs text-purple-600 dark:text-purple-300 mb-1">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¹Ù‡Ø¯</div>
                                                <div className="text-lg md:text-xl font-bold text-purple-700 dark:text-purple-200">{clearedTotalAmount.toFixed(2)}</div>
                                            </div>
                                            <div className="bg-orange-50 dark:bg-orange-900 rounded-lg p-2 md:p-3 text-center">
                                                <div className="text-xs text-orange-600 dark:text-orange-300 mb-1">Ø¹Ø¯Ø¯ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</div>
                                                <div className="text-lg md:text-xl font-bold text-orange-700 dark:text-orange-200">{clearedTotalExpenseCount}</div>
                                            </div>
                                            <div className="bg-red-50 dark:bg-red-900 rounded-lg p-2 md:p-3 text-center">
                                                <div className="text-xs text-red-600 dark:text-red-300 mb-1">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</div>
                                                <div className="text-lg md:text-xl font-bold text-red-700 dark:text-red-200">{clearedTotalExpenses.toFixed(2)}</div>
                                            </div>
                                            <div className={`rounded-lg p-2 md:p-3 text-center ${clearedTotalRemaining > 0 ? 'bg-green-50 dark:bg-green-900' : 'bg-slate-50 dark:bg-slate-700'}`}>
                                                <div className={`text-xs mb-1 ${clearedTotalRemaining > 0 ? 'text-green-600 dark:text-green-300' : 'text-slate-600 dark:text-slate-400'}`}>
                                                    Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ
                                                </div>
                                                <div className={`text-lg md:text-xl font-bold ${clearedTotalRemaining > 0 ? 'text-green-700 dark:text-green-200' : 'text-slate-700 dark:text-slate-300'}`}>
                                                    {clearedTotalRemaining.toFixed(2)}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                <div className="space-y-3 md:space-y-4">
                                    {sortedList.map((custody, idx) => {
                                        const remaining = calcRemaining(custody);
                                        const isReady = remaining <= 0.01 && remaining >= -0.01;
                                        const isCleared = activeTab === 'cleared';

                                        return (
                                            <div id={`custody-${custody.id}`} key={custody.id} className={`${darkMode ? 'bg-slate-800' : 'bg-white'} rounded-xl shadow-lg p-4 md:p-6 ${isCleared ? 'opacity-60' : ''}`}>
                                                <div className="flex flex-col md:flex-row items-start md:items-center gap-3 md:gap-4 mb-4">
                                                    {activeTab === 'active' && !isReadOnly && (
                                                        <input type="checkbox" checked={selectedIds.includes(custody.id)} onChange={(e) => setSelectedIds(e.target.checked ? [...selectedIds, custody.id] : selectedIds.filter(id => id !== custody.id))} className="w-5 h-5 mt-1 md:mt-0" />
                                                    )}

                                                    <div className="flex-1 w-full">
                                                        {editingId === custody.id && !custody.locked && !isReadOnly ? (
                                                            <div className="flex flex-col md:flex-row gap-2">
                                                                <input type="text" value={custody.name} onChange={(e) => updateCustody(custody.id, 'name', e.target.value)} className={`flex-1 px-3 py-2 border rounded-lg text-sm ${darkMode ? 'bg-slate-700 border-slate-600 text-white' : 'border-slate-300'}`} />
                                                                <input type="number" value={custody.amount} onChange={(e) => updateCustody(custody.id, 'amount', parseFloat(e.target.value))} className={`w-full md:w-32 px-3 py-2 border rounded-lg text-sm ${darkMode ? 'bg-slate-700 border-slate-600 text-white' : 'border-slate-300'}`} />
                                                                <input type="date" value={custody.date} onChange={(e) => updateCustody(custody.id, 'date', e.target.value)} className={`w-full md:w-40 px-3 py-2 border rounded-lg text-sm ${darkMode ? 'bg-slate-700 border-slate-600 text-white' : 'border-slate-300'}`} />
                                                                <button onClick={() => setEditingId(null)} className="px-4 py-2 bg-green-600 text-white rounded-lg">
                                                                    <Check />
                                                                </button>
                                                            </div>
                                                        ) : (
                                                            <div>
                                                                <h3 className={`text-lg md:text-xl font-bold ${darkMode ? 'text-white' : 'text-slate-800'}`}>
                                                                    #{custody.seqNumber} - {custody.name}
                                                                </h3>
                                                                <div className={`flex flex-wrap gap-2 md:gap-4 text-xs md:text-sm ${darkMode ? 'text-slate-400' : 'text-slate-600'} mt-1`}>
                                                                    <span>Ø§Ù„ØªØ§Ø±ÙŠØ®: {new Date(custody.date).toLocaleDateString('ar-SA')}</span>
                                                                    <span>Ø§Ù„Ù…Ø¨Ù„Øº: {custody.amount.toFixed(2)} Ø±ÙŠØ§Ù„</span>
                                                                    <span>Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª: {calcCustodyExpenses(custody).toFixed(2)} Ø±ÙŠØ§Ù„</span>
                                                                    <span className={`font-semibold ${remaining < 0 ? 'text-red-600 dark:text-red-400' : 'text-green-600 dark:text-green-400'}`}>
                                                                        Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: {remaining.toFixed(2)} Ø±ÙŠØ§Ù„
                                                                    </span>
                                                                </div>
                                                            </div>
                                                        )}
                                                    </div>

                                                    {isReady && !isCleared && !isReadOnly && (
                                                        <div className="flex flex-col md:flex-row items-stretch md:items-center gap-2 w-full md:w-auto">
                                                            <span className="text-green-600 dark:text-green-400 font-semibold text-sm text-center">Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØµÙÙŠØ©</span>
                                                            <button onClick={() => clearCustody(custody.id)} className="px-3 md:px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center justify-center gap-2 text-sm">
                                                                <Archive /> ØªØµÙÙŠØ©
                                                            </button>
                                                        </div>
                                                    )}

                                                    {!isReady && !isCleared && activeTab === 'active' && remaining > 0 && !isReadOnly && (
                                                        <button onClick={() => clearCustody(custody.id, true)} className="w-full md:w-auto px-3 md:px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 text-sm">
                                                            ØªØµÙÙŠØ© Ù…Ø¨ÙƒØ±Ø©
                                                        </button>
                                                    )}

                                                    {isCleared && !isReadOnly && (
                                                        <button onClick={() => restoreCustody(custody.id)} className="w-full md:w-auto px-3 md:px-4 py-2 bg-blue-600 text-white rounded-lg text-sm">Ø§Ø³ØªØ±Ø¬Ø§Ø¹</button>
                                                    )}

                                                    {activeTab === 'active' && !isReadOnly && (
                                                        <div className="flex gap-2 flex-wrap md:flex-nowrap w-full md:w-auto">
                                                            <button onClick={() => moveCustody(custody.id, 'up')} disabled={idx === 0} className={`p-2 ${darkMode ? 'bg-slate-700' : 'bg-slate-200'} rounded-lg disabled:opacity-30`}>
                                                                <ChevronUp />
                                                            </button>
                                                            <button onClick={() => moveCustody(custody.id, 'down')} disabled={idx === sortedList.length - 1} className={`p-2 ${darkMode ? 'bg-slate-700' : 'bg-slate-200'} rounded-lg disabled:opacity-30`}>
                                                                <ChevronDown />
                                                            </button>
                                                            <button onClick={() => toggleLock(custody.id)} className={`p-2 rounded-lg ${custody.locked ? 'bg-red-100 dark:bg-red-900 text-red-600 dark:text-red-400' : `${darkMode ? 'bg-slate-700' : 'bg-slate-200'}`}`}>
                                                                {custody.locked ? <Lock /> : <Unlock />}
                                                            </button>
                                                            <button onClick={() => setEditingId(editingId === custody.id ? null : custody.id)} disabled={custody.locked} className={`p-2 bg-blue-100 dark:bg-blue-900 text-blue-600 dark:text-blue-400 rounded-lg disabled:opacity-30`}>
                                                                <Edit2 />
                                                            </button>
                                                            <button onClick={() => deleteCustody(custody.id)} disabled={custody.locked} className={`p-2 bg-red-100 dark:bg-red-900 text-red-600 dark:text-red-400 rounded-lg disabled:opacity-30`}>
                                                                <Trash2 />
                                                            </button>
                                                        </div>
                                                    )}
                                                </div>

                                                {activeTab === 'active' && !custody.locked && (
                                                    <div className="mt-4 space-y-2">
                                                        <div className="flex items-center justify-between">
                                                            <button onClick={() => setExpandedExpenses({ ...expandedExpenses, [custody.id]: !expandedExpenses[custody.id] })} className={`${darkMode ? 'text-blue-400' : 'text-blue-600'} font-semibold text-sm`}>
                                                                {expandedExpenses[custody.id] ? 'â–¼' : 'â—€'} Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª ({custody.expenses.length})
                                                            </button>
                                                            {!isReadOnly && (
                                                                <button onClick={() => addExpense(custody.id)} className="px-3 md:px-4 py-1 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-xs md:text-sm flex items-center gap-1">
                                                                    <Plus /> Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ
                                                                </button>
                                                            )}
                                                        </div>

                                                        {expandedExpenses[custody.id] && (
                                                            <div className={`space-y-2 ${darkMode ? 'bg-slate-700' : 'bg-slate-50'} p-3 md:p-4 rounded-lg`}>
                                                                {custody.expenses.map((exp) => (
                                                                    <div 
                                                                        key={exp.id} 
                                                                        ref={el => expenseRefs.current[`${custody.id}-${exp.id}`] = el}
                                                                        className={`flex flex-col md:flex-row gap-2 items-start md:items-center ${darkMode ? 'bg-slate-800' : 'bg-white'} p-2 md:p-3 rounded-lg ${highlightedExpense === `${custody.id}-${exp.id}` ? 'ring-2 ring-yellow-400' : ''}`}
                                                                    >
                                                                        <div className={`text-xs ${darkMode ? 'text-slate-400' : 'text-slate-500'} font-mono w-12`}>#{exp.seqNumber}</div>
                                                                        {!isReadOnly ? (
                                                                            <>
                                                                                <select value={exp.expenseType} onChange={(e) => updateExpense(custody.id, exp.id, 'expenseType', e.target.value)} className={`w-full md:w-auto px-2 md:px-3 py-2 border rounded-lg text-xs md:text-sm ${darkMode ? 'bg-slate-700 border-slate-600 text-white' : 'border-slate-300'}`}>
                                                                                    <option value="">Ù†ÙˆØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙ</option>
                                                                                    {predefinedExpenses.map(pe => (
                                                                                        <option key={pe.id} value={pe.id}>
                                                                                            {pe.name} {pe.hasFixedPrice ? `(${pe.fixedPrice} Ø±ÙŠØ§Ù„)` : ''}
                                                                                        </option>
                                                                                    ))}
                                                                                </select>
                                                                                <input type="text" placeholder="Ø§Ø³Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©" value={exp.name} onChange={(e) => updateExpense(custody.id, exp.id, 'name', e.target.value)} className={`flex-1 px-2 md:px-3 py-2 border rounded-lg text-xs md:text-sm ${darkMode ? 'bg-slate-700 border-slate-600 text-white' : 'border-slate-300'}`} />
                                                                                <input type="number" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" value={exp.amount} onChange={(e) => updateExpense(custody.id, exp.id, 'amount', e.target.value)} className={`w-full md:w-28 px-2 md:px-3 py-2 border rounded-lg text-xs md:text-sm ${darkMode ? 'bg-slate-700 border-slate-600 text-white' : 'border-slate-300'}`} />
                                                                                <input type="date" value={exp.date} onChange={(e) => updateExpense(custody.id, exp.id, 'date', e.target.value)} className={`w-full md:w-36 px-2 md:px-3 py-2 border rounded-lg text-xs md:text-sm ${darkMode ? 'bg-slate-700 border-slate-600 text-white' : 'border-slate-300'}`} />
                                                                                <button onClick={() => updateExpense(custody.id, exp.id, 'includeTax', !exp.includeTax)} className={`px-2 md:px-3 py-2 rounded-lg text-xs whitespace-nowrap ${exp.includeTax ? 'bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300' : 'bg-yellow-100 dark:bg-yellow-900 text-yellow-700 dark:text-yellow-300'}`}>
                                                                                    {exp.includeTax ? 'Ø´Ø§Ù…Ù„ Ø¶Ø±ÙŠØ¨Ø©' : 'Ø¨Ø¯ÙˆÙ† Ø¶Ø±ÙŠØ¨Ø©'}
                                                                                </button>
                                                                                <span className={`text-xs md:text-sm ${darkMode ? 'text-slate-400' : 'text-slate-600'} w-full md:w-24 text-center`}>{calcExpenseTotal(exp).toFixed(2)} Ø±ÙŠØ§Ù„</span>
                                                                                <button onClick={() => deleteExpense(custody.id, exp.id)} className="p-2 bg-red-100 dark:bg-red-900 text-red-600 dark:text-red-400 rounded-lg w-full md:w-auto">
                                                                                    <X />
                                                                                </button>
                                                                            </>
                                                                        ) : (
                                                                            <div className={`flex-1 text-xs md:text-sm ${darkMode ? 'text-slate-300' : 'text-slate-700'}`}>
                                                                                <div className="font-semibold">{exp.name}</div>
                                                                                <div className={darkMode ? 'text-slate-400' : 'text-slate-500'}>{exp.amount} Ø±ÙŠØ§Ù„ - {exp.includeTax ? 'Ø´Ø§Ù…Ù„ Ø¶Ø±ÙŠØ¨Ø©' : 'Ø¨Ø¯ÙˆÙ† Ø¶Ø±ÙŠØ¨Ø©'} - {new Date(exp.date).toLocaleDateString('ar-SA')}</div>
                                                                            </div>
                                                                        )}
                                                                    </div>
                                                                ))}
                                                                {!isReadOnly && (
                                                                    <button onClick={() => addExpense(custody.id)} className={`w-full py-2 ${darkMode ? 'bg-slate-600 text-blue-400' : 'bg-blue-50 text-blue-600'} rounded-lg hover:bg-blue-100 dark:hover:bg-slate-500 flex items-center justify-center gap-2 border-2 border-dashed ${darkMode ? 'border-slate-500' : 'border-blue-300'} text-sm`}>
                                                                        <Plus /> Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ Ø¢Ø®Ø±
                                                                    </button>
                                                                )}
                                                            </div>
                                                        )}
                                                    </div>
                                                )}
                                            </div>
                                        );
                                    })}

                                    {sortedList.length === 0 && (
                                        <div className={`${darkMode ? 'bg-slate-800' : 'bg-white'} rounded-xl shadow-lg p-12 text-center ${darkMode ? 'text-slate-400' : 'text-slate-400'}`}>
                                            <p className="text-lg md:text-xl">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù‡Ø¯ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</p>
                                        </div>
                                    )}
                                </div>
                            </>
                        )}

                        {/* Reports Tab */}
                        {mainTab === 'reports' && (
                            <div className={`${darkMode ? 'bg-slate-800' : 'bg-white'} rounded-2xl shadow-xl p-4 md:p-6`}>
                                <h2 className={`text-xl md:text-2xl font-bold ${darkMode ? 'text-white' : 'text-slate-800'} mb-6`}>ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</h2>
                                
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                    <div>
                                        <label className={`block text-sm font-semibold ${darkMode ? 'text-slate-300' : 'text-slate-700'} mb-2`}>Ù†ÙˆØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙ</label>
                                        <select value={selectedExpenseType} onChange={(e) => setSelectedExpenseType(e.target.value)} className={`w-full px-3 md:px-4 py-2 border rounded-lg text-sm ${darkMode ? 'bg-slate-700 border-slate-600 text-white' : 'border-slate-300'}`}>
                                            <option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙ</option>
                                            {predefinedExpenses.map(pe => <option key={pe.id} value={pe.id}>{pe.name}</option>)}
                                        </select>
                                    </div>
                                    <div>
                                        <label className={`block text-sm font-semibold ${darkMode ? 'text-slate-300' : 'text-slate-700'} mb-2`}>Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©</label>
                                        <select value={reportPeriod} onChange={(e) => setReportPeriod(e.target.value)} className={`w-full px-3 md:px-4 py-2 border rounded-lg text-sm ${darkMode ? 'bg-slate-700 border-slate-600 text-white' : 'border-slate-300'}`}>
                                            <option value="2days">ÙŠÙˆÙ…ÙŠÙ†</option>
                                            <option value="week">Ø£Ø³Ø¨ÙˆØ¹</option>
                                            <option value="month">Ø´Ù‡Ø±</option>
                                            <option value="year">Ø³Ù†Ø©</option>
                                            <option value="2years">Ø³Ù†ØªÙŠÙ†</option>
                                            <option value="5years">5 Ø³Ù†ÙŠÙ†</option>
                                            <option value="custom">ÙØªØ±Ø© Ù…Ø®ØµØµØ©</option>
                                        </select>
                                    </div>
                                </div>

                                {reportPeriod === 'custom' && (
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                        <div>
                                            <label className={`block text-sm font-semibold ${darkMode ? 'text-slate-300' : 'text-slate-700'} mb-2`}>Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
                                            <input type="date" value={customStartDate} onChange={(e) => setCustomStartDate(e.target.value)} className={`w-full px-3 md:px-4 py-2 border rounded-lg ${darkMode ? 'bg-slate-700 border-slate-600 text-white' : 'border-slate-300'}`} />
                                        </div>
                                        <div>
                                            <label className={`block text-sm font-semibold ${darkMode ? 'text-slate-300' : 'text-slate-700'} mb-2`}>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
                                            <input type="date" value={customEndDate} onChange={(e) => setCustomEndDate(e.target.value)} className={`w-full px-3 md:px-4 py-2 border rounded-lg ${darkMode ? 'bg-slate-700 border-slate-600 text-white' : 'border-slate-300'}`} />
                                        </div>
                                    </div>
                                )}

                                {reportData && (
                                    <div className="mt-6">
                                        <div className="bg-blue-50 dark:bg-blue-900 rounded-xl p-4 md:p-6 mb-6">
                                            <h3 className="text-lg md:text-xl font-bold text-blue-900 dark:text-blue-200 mb-4">ØªÙ‚Ø±ÙŠØ±: {reportData.expenseName}</h3>
                                            <div className="text-xs md:text-sm text-blue-700 dark:text-blue-300 mb-4">
                                                Ø§Ù„ÙØªØ±Ø©: {reportData.startDate.toLocaleDateString('ar-SA')} - {reportData.endDate.toLocaleDateString('ar-SA')}
                                            </div>
                                            
                                            <div className="grid grid-cols-1 md:grid-cols-3 gap-3 md:gap-4">
                                                <div className={`${darkMode ? 'bg-slate-800' : 'bg-white'} rounded-lg p-3 md:p-4 text-center`}>
                                                    <div className={`text-xs md:text-sm ${darkMode ? 'text-slate-400' : 'text-slate-600'} mb-1`}>Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù‡Ø¯</div>
                                                    <div className="text-xl md:text-2xl font-bold text-blue-700 dark:text-blue-300">{reportData.custodiesCount}</div>
                                                </div>
                                                <div className={`${darkMode ? 'bg-slate-800' : 'bg-white'} rounded-lg p-3 md:p-4 text-center`}>
                                                    <div className={`text-xs md:text-sm ${darkMode ? 'text-slate-400' : 'text-slate-600'} mb-1`}>Ø¹Ø¯Ø¯ Ù…ØµØ±ÙˆÙØ§Øª {reportData.expenseName}</div>
                                                    <div className="text-xl md:text-2xl font-bold text-purple-700 dark:text-purple-300">{reportData.expenseCount}</div>
                                                </div>
                                                <div className={`${darkMode ? 'bg-slate-800' : 'bg-white'} rounded-lg p-3 md:p-4 text-center`}>
                                                    <div className={`text-xs md:text-sm ${darkMode ? 'text-slate-400' : 'text-slate-600'} mb-1`}>Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØµØ±Ù {reportData.expenseName}</div>
                                                    <div className="text-xl md:text-2xl font-bold text-green-700 dark:text-green-300">{reportData.totalExpenses.toFixed(2)} Ø±ÙŠØ§Ù„</div>
                                                </div>
                                            </div>
                                        </div>

                                        <div className={`${darkMode ? 'bg-slate-700' : 'bg-slate-50'} rounded-xl p-3 md:p-4`}>
                                            <h4 className={`font-bold ${darkMode ? 'text-white' : 'text-slate-800'} mb-3 text-sm md:text-base`}>Ø§Ù„Ø¹Ù‡Ø¯ ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©:</h4>
                                            <div className="space-y-2">
                                                {reportData.custodies.map(custody => {
                                                    const custExpenses = custody.expenses.filter(e => e.expenseType === selectedExpenseType);
                                                    if (custExpenses.length === 0) return null;
                                                    return (
                                                        <div key={custody.id} className={`${darkMode ? 'bg-slate-800' : 'bg-white'} rounded-lg p-2 md:p-3`}>
                                                            <div className={`text-xs md:text-sm font-semibold ${darkMode ? 'text-slate-300' : 'text-slate-700'}`}>
                                                                #{custody.seqNumber} - {custody.name}
                                                                <span className={`text-xs ${darkMode ? 'text-slate-500' : 'text-slate-500'} mr-2`}>({new Date(custody.date).toLocaleDateString('ar-SA')})</span>
                                                            </div>
                                                            <div className={`text-xs ${darkMode ? 'text-slate-400' : 'text-slate-600'} mt-1`}>
                                                                Ø¹Ø¯Ø¯ Ù…ØµØ±ÙˆÙØ§Øª {reportData.expenseName}: {custExpenses.length} | Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: {custExpenses.reduce((s, e) => s + calcExpenseTotal(e), 0).toFixed(2)} Ø±ÙŠØ§Ù„
                                                            </div>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {!selectedExpenseType && (
                                    <div className={`mt-6 text-center ${darkMode ? 'text-slate-400' : 'text-slate-400'}`}>
                                        <p className="text-base md:text-lg">Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙ Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</p>
                                    </div>
                                )}
                            </div>
                        )}

                        {/* Settings Tab */}
                        {mainTab === 'settings' && (
                            <div className={`${darkMode ? 'bg-slate-800' : 'bg-white'} rounded-2xl shadow-xl p-4 md:p-6`}>
                                <h2 className={`text-xl md:text-2xl font-bold ${darkMode ? 'text-white' : 'text-slate-800'} mb-6`}>Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ù…Ø¹Ø±ÙØ©</h2>
                                
                                {!isReadOnly && (
                                    <div className={`mb-6 ${darkMode ? 'bg-slate-700' : 'bg-slate-50'} rounded-xl p-3 md:p-4`}>
                                        <h3 className={`font-bold ${darkMode ? 'text-white' : 'text-slate-700'} mb-3 text-sm md:text-base`}>Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ Ø¬Ø¯ÙŠØ¯</h3>
                                        <div className="flex flex-col md:flex-row gap-2 items-end">
                                            <div className="flex-1 w-full">
                                                <label className={`block text-xs md:text-sm ${darkMode ? 'text-slate-300' : 'text-slate-600'} mb-1`}>Ø§Ø³Ù… Ø§Ù„Ù…ØµØ±ÙˆÙ</label>
                                                <input type="text" placeholder="Ù…Ø«Ø§Ù„: Ø¨Ù†Ø²ÙŠÙ†ØŒ Ù„Ø­Ø§Ù…ØŒ ØµÙŠØ§Ù†Ø©" value={newPredefined.name} onChange={(e) => setNewPredefined({ ...newPredefined, name: e.target.value })} className={`w-full px-3 md:px-4 py-2 border rounded-lg text-sm ${darkMode ? 'bg-slate-600 border-slate-500 text-white' : 'border-slate-300'}`} />
                                            </div>
                                            <div className="w-full md:w-40">
                                                <label className="flex items-center gap-2 mb-2">
                                                    <input type="checkbox" checked={newPredefined.hasFixedPrice} onChange={(e) => setNewPredefined({ ...newPredefined, hasFixedPrice: e.target.checked })} className="w-4 h-4" />
                                                    <span className={`text-xs md:text-sm ${darkMode ? 'text-slate-300' : 'text-slate-600'}`}>Ø³Ø¹Ø± Ø«Ø§Ø¨Øª</span>
                                                </label>
                                                <input type="number" placeholder="Ø§Ù„Ø³Ø¹Ø±" value={newPredefined.fixedPrice} onChange={(e) => setNewPredefined({ ...newPredefined, fixedPrice: e.target.value })} disabled={!newPredefined.hasFixedPrice} className={`w-full px-3 md:px-4 py-2 border rounded-lg disabled:bg-slate-100 dark:disabled:bg-slate-800 text-sm ${darkMode ? 'bg-slate-600 border-slate-500 text-white' : 'border-slate-300'}`} />
                                            </div>
                                            <button onClick={addPredefined} className="w-full md:w-auto px-4 md:px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center justify-center gap-2 text-sm">
                                                <Plus /> Ø¥Ø¶Ø§ÙØ©
                                            </button>
                                        </div>
                                    </div>
                                )}

                                <div className="space-y-2">
                                    {predefinedExpenses.map((exp) => (
                                        <div key={exp.id} className={`flex flex-col md:flex-row items-start md:items-center gap-2 md:gap-3 ${darkMode ? 'bg-slate-700' : 'bg-slate-50'} p-3 md:p-4 rounded-lg`}>
                                            {editingPredefinedId === exp.id && !isReadOnly ? (
                                                <>
                                                    <input type="text" value={exp.name} onChange={(e) => updatePredefined(exp.id, 'name', e.target.value)} className={`flex-1 px-3 py-2 border rounded-lg text-sm ${darkMode ? 'bg-slate-600 border-slate-500 text-white' : 'border-slate-300'}`} />
                                                    <label className="flex items-center gap-2">
                                                        <input type="checkbox" checked={exp.hasFixedPrice} onChange={(e) => updatePredefined(exp.id, 'hasFixedPrice', e.target.checked)} className="w-4 h-4" />
                                                        <span className="text-xs md:text-sm">Ø³Ø¹Ø± Ø«Ø§Ø¨Øª</span>
                                                    </label>
                                                    <input type="number" value={exp.fixedPrice} onChange={(e) => updatePredefined(exp.id, 'fixedPrice', parseFloat(e.target.value))} disabled={!exp.hasFixedPrice} className={`w-full md:w-32 px-3 py-2 border rounded-lg disabled:bg-slate-100 dark:disabled:bg-slate-800 text-sm ${darkMode ? 'bg-slate-600 border-slate-500 text-white' : 'border-slate-300'}`} />
                                                    <button onClick={() => setEditingPredefinedId(null)} className="w-full md:w-auto p-2 bg-green-600 text-white rounded-lg">
                                                        <Check />
                                                    </button>
                                                </>
                                            ) : (
                                                <>
                                                    <div className="flex-1">
                                                        <div className={`font-semibold ${darkMode ? 'text-white' : 'text-slate-800'} text-sm md:text-base`}>{exp.name}</div>
                                                        {exp.hasFixedPrice && (
                                                            <div className={`text-xs md:text-sm ${darkMode ? 'text-slate-400' : 'text-slate-600'}`}>Ø³Ø¹Ø± Ø«Ø§Ø¨Øª: {exp.fixedPrice} Ø±ÙŠØ§Ù„ (Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©)</div>
                                                        )}
                                                    </div>
                                                    {!isReadOnly && (
                                                        <div className="flex gap-2 w-full md:w-auto">
                                                            <button onClick={() => setEditingPredefinedId(exp.id)} className={`flex-1 md:flex-none p-2 ${darkMode ? 'bg-blue-900' : 'bg-blue-100'} ${darkMode ? 'text-blue-400' : 'text-blue-600'} rounded-lg`}>
                                                                <Edit2 />
                                                            </button>
                                                            <button onClick={() => deletePredefined(exp.id)} className={`flex-1 md:flex-none p-2 ${darkMode ? 'bg-red-900' : 'bg-red-100'} ${darkMode ? 'text-red-400' : 'text-red-600'} rounded-lg`}>
                                                                <Trash2 />
                                                            </button>
                                                        </div>
                                                    )}
                                                </>
                                            )}
                                        </div>
                                    ))}

                                    {predefinedExpenses.length === 0 && (
                                        <div className={`text-center py-12 ${darkMode ? 'text-slate-400' : 'text-slate-400'}`}>
                                            <p className="text-base md:text-lg">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ§Ø±ÙŠÙ Ù…Ø¹Ø±ÙØ©. Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© Ø£ÙˆÙ„ Ù…ØµØ±ÙˆÙ!</p>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        ReactDOM.render(<CustodyManager />, document.getElementById('root'));
    </script>
</body>
</html>
