<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;
        const user = localStorage.getItem('currentUser');
        if (!user) window.location.href = 'index.html';

        const supabase = window.supabase.createClient(
            'https://opyuncxyjdqxawddhdjn.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9weXVuY3h5amRxeGF3ZGRoZGpuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyOTkyNjIsImV4cCI6MjA4MTg3NTI2Mn0.BFObQBOTaUCWktaaCGNBbm_UQ98j4GG9QXz_cOywz0M'
        );

        function ProjectsApp() {
            const [projects, setProjects] = useState([]);
            const [custodies, setCustodies] = useState([]);
            const [expenses, setExpenses] = useState([]);
            const [tab, setTab] = useState('active');
            const [selectedProject, setSelectedProject] = useState(null);
            const [showAddForm, setShowAddForm] = useState(false);

            useEffect(() => { loadData(); }, [tab]);

            const loadData = async () => {
                const [p, c, e] = await Promise.all([
                    supabase.from('projects').select('*').eq('username', user).eq('status', tab).order('created_at', { ascending: false }),
                    supabase.from('custodies').select('*').eq('username', user),
                    supabase.from('expenses').select('*')
                ]);
                
                setProjects(p.data || []);
                setCustodies(c.data || []);
                setExpenses(e.data || []);
            };

            const addProject = async (e) => {
                e.preventDefault();
                const form = e.target;
                
                await supabase.from('projects').insert({
                    username: user,
                    name: form.name.value,
                    description: form.desc.value,
                    budget: parseFloat(form.budget.value) || null,
                    start_date: form.start_date.value,
                    status: 'active'
                });
                
                form.reset();
                setShowAddForm(false);
                loadData();
            };

            const closeProject = async (id) => {
                if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥ØºÙ„Ø§Ù‚ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ØŸ')) {
                    await supabase.from('projects').update({ 
                        status: 'closed',
                        end_date: new Date().toISOString().split('T')[0]
                    }).eq('id', id);
                    loadData();
                }
            };

            const reopenProject = async (id) => {
                if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø¹Ø§Ø¯Ø© ÙØªØ­ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ØŸ')) {
                    await supabase.from('projects').update({ 
                        status: 'active',
                        end_date: null
                    }).eq('id', id);
                    loadData();
                }
            };

            const deleteProject = async (id) => {
                if (confirm('Ø­Ø°Ù Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ØŸ (Ø³ÙŠØªÙ… ÙÙƒ Ø§Ø±ØªØ¨Ø§Ø· Ø§Ù„Ø¹Ù‡Ø¯ Ø¨Ù‡)')) {
                    await supabase.from('projects').delete().eq('id', id);
                    loadData();
                }
            };

            const getProjectCustodies = (projectId) => custodies.filter(c => c.project_id === projectId);
            const getTotalExpenses = (custodyId) => expenses.filter(e => e.custody_id === custodyId).reduce((s, e) => s + e.amount, 0);
            
            const getProjectStats = (projectId) => {
                const projectCustodies = getProjectCustodies(projectId);
                const totalBudget = projectCustodies.reduce((s, c) => s + c.amount, 0);
                const totalSpent = projectCustodies.reduce((s, c) => s + getTotalExpenses(c.id), 0);
                const remaining = totalBudget - totalSpent;
                const percentage = totalBudget > 0 ? (totalSpent / totalBudget * 100).toFixed(1) : 0;
                
                return {
                    custodiĞµÑCount: projectCustodies.length,
                    totalBudget,
                    totalSpent,
                    remaining,
                    percentage,
                    activeCustodies: projectCustodies.filter(c => c.status === 'active').length,
                    clearedCustodies: projectCustodies.filter(c => c.status === 'cleared').length
                };
            };

            const printProjectReport = (project) => {
                const stats = getProjectStats(project.id);
                const projectCustodies = getProjectCustodies(project.id);
                
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html dir="rtl">
                    <head>
                        <meta charset="UTF-8">
                        <title>ØªÙ‚Ø±ÙŠØ± Ù…Ø´Ø±ÙˆØ¹ - ${project.name}</title>
                        <style>
                            body { font-family: 'Segoe UI', Tahoma, Arial; direction: rtl; padding: 20px; }
                            .header { text-align: center; border-bottom: 3px solid #0084ff; padding-bottom: 20px; margin-bottom: 30px; }
                            .header h1 { color: #0084ff; margin: 10px 0; }
                            .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 30px; }
                            .info-box { background: #f8f9fa; padding: 15px; border-radius: 8px; border-right: 4px solid #0084ff; }
                            .info-box strong { color: #1c1e21; display: block; margin-bottom: 5px; }
                            .stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin: 30px 0; }
                            .stat-card { background: #f0f7ff; padding: 15px; border-radius: 8px; text-align: center; }
                            .stat-card .label { font-size: 0.85rem; color: #65676b; }
                            .stat-card .value { font-size: 1.5rem; font-weight: bold; color: #0084ff; margin: 5px 0; }
                            table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                            th, td { padding: 12px; text-align: right; border-bottom: 1px solid #ddd; }
                            th { background: #0084ff; color: white; }
                            .footer { margin-top: 40px; text-align: center; color: #65676b; font-size: 0.9rem; }
                            @media print {
                                .no-print { display: none; }
                                @page { margin: 1cm; }
                            }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h1>ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ù…Ø´Ø±ÙˆØ¹</h1>
                            <h2>${project.name}</h2>
                            <p>${project.description || ''}</p>
                        </div>
                        
                        <div class="info-grid">
                            <div class="info-box">
                                <strong>ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡:</strong>
                                <span>${project.start_date || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>
                            </div>
                            <div class="info-box">
                                <strong>ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡:</strong>
                                <span>${project.end_date || 'Ù…Ø³ØªÙ…Ø±'}</span>
                            </div>
                            <div class="info-box">
                                <strong>ğŸ‘¤ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„:</strong>
                                <span>${user}</span>
                            </div>
                            <div class="info-box">
                                <strong>ğŸ“Œ Ø§Ù„Ø­Ø§Ù„Ø©:</strong>
                                <span>${project.status === 'active' ? 'ğŸŸ¢ Ù†Ø´Ø·' : 'ğŸ”´ Ù…ØºÙ„Ù‚'}</span>
                            </div>
                        </div>

                        <div class="stats-row">
                            <div class="stat-card">
                                <div class="label">Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù‡Ø¯</div>
                                <div class="value">${stats.custodiĞµÑCount}</div>
                            </div>
                            <div class="stat-card">
                                <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©</div>
                                <div class="value">${stats.totalBudget.toFixed(2)}</div>
                                <div class="label">Ø±.Ø³</div>
                            </div>
                            <div class="stat-card">
                                <div class="label">Ø§Ù„Ù…ØµØ±ÙˆÙ</div>
                                <div class="value">${stats.totalSpent.toFixed(2)}</div>
                                <div class="label">${stats.percentage}%</div>
                            </div>
                            <div class="stat-card">
                                <div class="label">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</div>
                                <div class="value">${stats.remaining.toFixed(2)}</div>
                                <div class="label">Ø±.Ø³</div>
                            </div>
                        </div>

                        <h3>ğŸ“‹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù‡Ø¯</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Ø§Ù„ÙˆØµÙ</th>
                                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                    <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                                    <th>Ø§Ù„Ù…ØµØ±ÙˆÙ</th>
                                    <th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
                                    <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${projectCustodies.map((c, i) => {
                                    const spent = getTotalExpenses(c.id);
                                    const remaining = c.amount - spent;
                                    return `
                                        <tr>
                                            <td>${i + 1}</td>
                                            <td>${c.description}</td>
                                            <td>${c.date}</td>
                                            <td>${c.amount.toFixed(2)}</td>
                                            <td>${spent.toFixed(2)}</td>
                                            <td>${remaining.toFixed(2)}</td>
                                            <td>${c.status === 'active' ? 'ğŸŸ¢ Ù†Ø´Ø·Ø©' : 'âœ… Ù…ØµÙØ§Ø©'}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>

                        <div class="footer">
                            <p>ØªÙ… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ÙÙŠ: ${new Date().toLocaleString('ar-SA')}</p>
                            <p>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù‡Ø¯ - ${user}</p>
                        </div>

                        <button class="no-print" onclick="window.print()" style="position: fixed; top: 20px; left: 20px; padding: 10px 20px; background: #0084ff; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©
                        </button>
                    </body>
                    </html>
                `);
                printWindow.document.close();
            };

            const allStats = {
                activeCount: projects.filter(p => p.status === 'active').length,
                closedCount: projects.filter(p => p.status === 'closed').length,
                totalCustodies: custodies.filter(c => c.project_id !== null).length,
                unassignedCustodies: custodies.filter(c => c.project_id === null).length
            };

            return (
                <div className="app-container">
                    <div className="top-bar">
                        <button className="btn-back" onClick={() => window.location.href = 'dashboard.html'}>
                            <i className="fas fa-arrow-right"></i>
                        </button>
                        <h2><i className="fas fa-project-diagram"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ - {user}</h2>
                        <button className="btn-export" onClick={() => setShowAddForm(true)}>
                            <i className="fas fa-plus"></i>
                        </button>
                    </div>

                    <div className="stats-row">
                        <div className="stat-box blue">
                            <i className="fas fa-folder-open"></i>
                            <div>
                                <small>Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ù†Ø´Ø·Ø©</small>
                                <strong>{allStats.activeCount}</strong>
                            </div>
                        </div>
                        <div className="stat-box green">
                            <i className="fas fa-check-circle"></i>
                            <div>
                                <small>Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ù…ØºÙ„Ù‚Ø©</small>
                                <strong>{allStats.closedCount}</strong>
                            </div>
                        </div>
                        <div className="stat-box cyan">
                            <i className="fas fa-file-invoice"></i>
                            <div>
                                <small>Ø¹Ù‡Ø¯ Ù…Ø±ØªØ¨Ø·Ø©</small>
                                <strong>{allStats.totalCustodies}</strong>
                            </div>
                        </div>
                        <div className="stat-box orange">
                            <i className="fas fa-inbox"></i>
                            <div>
                                <small>Ø¹Ù‡Ø¯ ØºÙŠØ± Ù…Ø±ØªØ¨Ø·Ø©</small>
                                <strong>{allStats.unassignedCustodies}</strong>
                            </div>
                        </div>
                    </div>

                    {showAddForm && (
                        <div className="modal-overlay" onClick={() => setShowAddForm(false)}>
                            <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                                <h3><i className="fas fa-plus-circle"></i> Ù…Ø´Ø±ÙˆØ¹ Ø¬Ø¯ÙŠØ¯</h3>
                                <form onSubmit={addProject} className="neat-form">
                                    <div>
                                        <label><i className="fas fa-signature"></i> Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</label>
                                        <input name="name" required />
                                    </div>
                                    <div>
                                        <label><i className="fas fa-align-right"></i> Ø§Ù„ÙˆØµÙ</label>
                                        <textarea name="desc" rows="3"></textarea>
                                    </div>
                                    <div className="row-2">
                                        <div>
                                            <label><i className="fas fa-money-bill-wave"></i> Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                                            <input name="budget" type="number" step="0.01" placeholder="0.00" />
                                        </div>
                                        <div>
                                            <label><i className="fas fa-calendar"></i> ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡</label>
                                            <input name="start_date" type="date" defaultValue={new Date().toISOString().split('T')[0]} />
                                        </div>
                                    </div>
                                    <div className="row-btns">
                                        <button type="submit" className="btn-ok"><i className="fas fa-save"></i> Ø­ÙØ¸</button>
                                        <button type="button" className="btn-no" onClick={() => setShowAddForm(false)}>
                                            <i className="fas fa-times"></i> Ø¥Ù„ØºØ§Ø¡
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    <div className="tab-btns" style={{marginBottom: '20px'}}>
                        <button className={tab === 'active' ? 'active' : ''} onClick={() => setTab('active')}>
                            <i className="fas fa-folder-open"></i> Ø§Ù„Ù†Ø´Ø·Ø© ({allStats.activeCount})
                        </button>
                        <button className={tab === 'closed' ? 'active' : ''} onClick={() => setTab('closed')}>
                            <i className="fas fa-archive"></i> Ø§Ù„Ù…ØºÙ„Ù‚Ø© ({allStats.closedCount})
                        </button>
                    </div>

                    {projects.length === 0 ? (
                        <div className="no-data">
                            <i className="fas fa-inbox"></i>
                            <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ {tab === 'active' ? 'Ù†Ø´Ø·Ø©' : 'Ù…ØºÙ„Ù‚Ø©'}</p>
                            <button className="btn-main" onClick={() => setShowAddForm(true)}>
                                <i className="fas fa-plus"></i> Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø´Ø±ÙˆØ¹
                            </button>
                        </div>
                    ) : (
                        <div className="projects-grid">
                            {projects.map(project => {
                                const stats = getProjectStats(project.id);
                                
                                return (
                                    <div key={project.id} className="project-card">
                                        <div className="project-header">
                                            <div>
                                                <h3><i className="fas fa-project-diagram"></i> {project.name}</h3>
                                                {project.description && <p>{project.description}</p>}
                                            </div>
                                            <div className="action-btns">
                                                <button className="icon-btn" onClick={() => printProjectReport(project)} title="Ø·Ø¨Ø§Ø¹Ø©">
                                                    <i className="fas fa-print"></i>
                                                </button>
                                                <button className="icon-btn" onClick={() => window.location.href = `custody.html?project=${project.id}`} title="Ø§Ù„Ø¹Ù‡Ø¯">
                                                    <i className="fas fa-eye"></i>
                                                </button>
                                                {tab === 'active' ? (
                                                    <button className="icon-btn" onClick={() => closeProject(project.id)} title="Ø¥ØºÙ„Ø§Ù‚">
                                                        <i className="fas fa-archive"></i>
                                                    </button>
                                                ) : (
                                                    <button className="icon-btn restore-btn" onClick={() => reopenProject(project.id)} title="Ø¥Ø¹Ø§Ø¯Ø© ÙØªØ­">
                                                        <i className="fas fa-folder-open"></i>
                                                    </button>
                                                )}
                                                <button className="icon-btn del-btn" onClick={() => deleteProject(project.id)} title="Ø­Ø°Ù">
                                                    <i className="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>

                                        <div className="project-stats">
                                            <div className="mini-stat">
                                                <i className="fas fa-file-invoice"></i>
                                                <div>
                                                    <small>Ø§Ù„Ø¹Ù‡Ø¯</small>
                                                    <strong>{stats.custodiĞµÑCount}</strong>
                                                </div>
                                            </div>
                                            <div className="mini-stat">
                                                <i className="fas fa-money-bill-wave"></i>
                                                <div>
                                                    <small>Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©</small>
                                                    <strong>{stats.totalBudget.toFixed(0)}</strong>
                                                </div>
                                            </div>
                                            <div className="mini-stat">
                                                <i className="fas fa-chart-line"></i>
                                                <div>
                                                    <small>Ø§Ù„Ù…ØµØ±ÙˆÙ</small>
                                                    <strong>{stats.totalSpent.toFixed(0)}</strong>
                                                </div>
                                            </div>
                                            <div className="mini-stat">
                                                <i className="fas fa-wallet"></i>
                                                <div>
                                                    <small>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</small>
                                                    <strong>{stats.remaining.toFixed(0)}</strong>
                                                </div>
                                            </div>
                                        </div>

                                        <div className="progress-wrap">
                                            <div className="bar">
                                                <div className="fill" style={{width: `${Math.min(stats.percentage, 100)}%`}}></div>
                                            </div>
                                            <div className="nums">
                                                <span>{stats.percentage}% Ù…ØµØ±ÙˆÙ</span>
                                                <span>Ù†Ø´Ø·Ø©: {stats.activeCustodies} | Ù…ØµÙØ§Ø©: {stats.clearedCustodies}</span>
                                            </div>
                                        </div>

                                        <div className="project-footer">
                                            <small><i className="far fa-calendar"></i> {project.start_date}</small>
                                            {project.end_date && <small><i className="fas fa-flag-checkered"></i> {project.end_date}</small>}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    )}
                </div>
            );
        }

        ReactDOM.render(<ProjectsApp />, document.getElementById('root'));
    </script>
</body>
</html>
