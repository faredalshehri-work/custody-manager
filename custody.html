<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿπŸáÿØ</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;
        const user = localStorage.getItem('currentUser');
        if (!user) window.location.href = 'index.html';

        // Get project ID from URL if exists
        const urlParams = new URLSearchParams(window.location.search);
        const projectIdFromUrl = urlParams.get('project');

        const supabase = window.supabase.createClient(
            'https://opyuncxyjdqxawddhdjn.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9weXVuY3h5amRxeGF3ZGRoZGpuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyOTkyNjIsImV4cCI6MjA4MTg3NTI2Mn0.BFObQBOTaUCWktaaCGNBbm_UQ98j4GG9QXz_cOywz0M'
        );

        function CustodyApp() {
            const [custodies, setCustodies] = useState([]);
            const [allCustodies, setAllCustodies] = useState([]);
            const [expenses, setExpenses] = useState([]);
            const [projects, setProjects] = useState([]);
            const [tab, setTab] = useState('active');
            const [loading, setLoading] = useState(false);
            const [wallet, setWallet] = useState(0);
            const [searchTerm, setSearchTerm] = useState('');
            const [editingCustody, setEditingCustody] = useState(null);
            const [viewMode, setViewMode] = useState(localStorage.getItem('viewMode') || 'list');
            const [clearedFilter, setClearedFilter] = useState('all');
            const [expandedExpenses, setExpandedExpenses] = useState({});
            
            // Advanced Filters
            const [showFilters, setShowFilters] = useState(false);
            const [dateFrom, setDateFrom] = useState('');
            const [dateTo, setDateTo] = useState('');
            const [amountMin, setAmountMin] = useState('');
            const [amountMax, setAmountMax] = useState('');
            const [selectedProject, setSelectedProject] = useState(projectIdFromUrl || 'all');
            const [showProjectModal, setShowProjectModal] = useState(false);
            const [custodyToAssign, setCustodyToAssign] = useState(null);
            const [showQuickProject, setShowQuickProject] = useState(false);
            const [quickProjectForm, setQuickProjectForm] = useState(null);

            useEffect(() => { loadData(); }, [tab, clearedFilter, selectedProject]);
            useEffect(() => { localStorage.setItem('viewMode', viewMode); }, [viewMode]);

            const loadData = async () => {
                setLoading(true);
                
                let query = supabase.from('custodies').select('*').eq('username', user);
                
                if (tab === 'active') {
                    query = query.eq('status', 'active');
                } else {
                    query = query.eq('status', 'cleared');
                    if (clearedFilter === 'early') {
                        query = query.eq('cleared_early', true);
                    } else if (clearedFilter === 'complete') {
                        query = query.eq('cleared_early', false);
                    }
                }
                
                if (selectedProject && selectedProject !== 'all' && selectedProject !== 'unassigned') {
                    query = query.eq('project_id', parseInt(selectedProject));
                } else if (selectedProject === 'unassigned') {
                    query = query.is('project_id', null);
                }
                
                const [c, all, e, w, p] = await Promise.all([
                    query.order('date', { ascending: false }),
                    supabase.from('custodies').select('*').eq('username', user),
                    supabase.from('expenses').select('*'),
                    supabase.from('wallets').select('*').eq('username', user).single(),
                    supabase.from('projects').select('*').eq('username', user)
                ]);
                
                setCustodies(c.data || []);
                setAllCustodies(all.data || []);
                setExpenses(e.data || []);
                setWallet(w.data?.amount || 0);
                setProjects(p.data || []);
                setLoading(false);
            };

            const addCustody = async (e) => {
                e.preventDefault();
                const form = e.target;
                const useWallet = form.useWallet?.checked || false;
                const amount = parseFloat(form.amount.value);
                let projectId = form.project_id?.value || null;
                
                // If creating new project
                if (projectId === 'new') {
                    if (!quickProjectForm || !quickProjectForm.name) {
                        alert('ÿ£ÿØÿÆŸÑ ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ ÿ£ŸàŸÑÿßŸã');
                        return;
                    }
                    
                    const { data: newProject } = await supabase.from('projects').insert({
                        username: user,
                        name: quickProjectForm.name,
                        description: quickProjectForm.description || '',
                        status: 'active',
                        start_date: new Date().toISOString().split('T')[0]
                    }).select();
                    
                    projectId = newProject[0].id;
                    setQuickProjectForm(null);
                }
                
                if (useWallet && wallet < amount) {
                    alert('ÿßŸÑŸÖÿ®ŸÑÿ∫ ŸÅŸä ÿßŸÑŸÖÿ≠ŸÅÿ∏ÿ© ÿ∫Ÿäÿ± ŸÉÿßŸÅŸä!');
                    return;
                }
                
                await supabase.from('custodies').insert({
                    username: user, serial: Date.now(), date: form.date.value,
                    amount: amount, description: form.desc.value, status: 'active',
                    cleared_early: false,
                    project_id: projectId === 'null' || projectId === 'new' ? null : parseInt(projectId)
                });
                
                if (useWallet) await updateWallet(-amount);
                
                form.reset(); 
                form.date.value = new Date().toISOString().split('T')[0];
                setShowQuickProject(false);
                loadData();
            };

            const assignToProject = async (custodyId, projectId) => {
                await supabase.from('custodies').update({
                    project_id: projectId === 'null' ? null : parseInt(projectId)
                }).eq('id', custodyId);
                setCustodyToAssign(null);
                setShowProjectModal(false);
                loadData();
            };

            const updateCustody = async (e) => {
                e.preventDefault();
                const form = e.target;
                await supabase.from('custodies').update({
                    date: form.date.value,
                    amount: parseFloat(form.amount.value),
                    description: form.desc.value
                }).eq('id', editingCustody.id);
                
                setEditingCustody(null);
                loadData();
            };

            const updateWallet = async (amount) => {
                const newAmount = wallet + amount;
                const { data: existing } = await supabase.from('wallets').select('*').eq('username', user).single();
                
                if (existing) {
                    await supabase.from('wallets').update({ amount: newAmount }).eq('username', user);
                } else {
                    await supabase.from('wallets').insert({ username: user, amount: newAmount });
                }
            };

            const addExpense = async (custodyId, amount, desc) => {
                const custody = allCustodies.find(c => c.id === custodyId);
                const currentTotal = getTotalExpenses(custodyId);
                const newTotal = currentTotal + parseFloat(amount);
                
                if (newTotal > custody.amount) {
                    alert(`‚ö†Ô∏è ÿ™ÿ≠ÿ∞Ÿäÿ±!\nŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿµÿ±ŸàŸÅ Ÿäÿ™ÿ¨ÿßŸàÿ≤ ŸÖÿ®ŸÑÿ∫ ÿßŸÑÿπŸáÿØÿ©\n\nÿßŸÑŸÖÿ™ÿ®ŸÇŸä: ${(custody.amount - currentTotal).toFixed(2)} ÿ±.ÿ≥\nÿßŸÑŸÖÿ∑ŸÑŸàÿ®: ${amount} ÿ±.ÿ≥`);
                    return;
                }
                
                await supabase.from('expenses').insert({
                    custody_id: custodyId, serial: Date.now(), amount: parseFloat(amount), description: desc
                });
                loadData();
            };

            const clearCustody = async (id, early = false) => {
                const custody = allCustodies.find(c => c.id === id);
                const remaining = custody.amount - getTotalExpenses(id);
                
                if (early && remaining > 0) {
                    if (!confirm(`ÿ™ÿµŸÅŸäÿ© ŸÖÿ®ŸÉÿ±ÿ©\nÿßŸÑŸÖÿ™ÿ®ŸÇŸä ${remaining.toFixed(2)} ÿ±.ÿ≥ ÿ≥Ÿäÿ∂ÿßŸÅ ŸÑŸÑŸÖÿ≠ŸÅÿ∏ÿ©\nŸÖÿ™ÿ£ŸÉÿØÿü`)) return;
                    await updateWallet(remaining);
                    await supabase.from('custodies').update({ status: 'cleared', cleared_early: true }).eq('id', id);
                } else {
                    if (!confirm('ÿ™ÿ£ŸÉŸäÿØ ÿ™ÿµŸÅŸäÿ© ÿßŸÑÿπŸáÿØÿ©ÿü')) return;
                    await supabase.from('custodies').update({ status: 'cleared', cleared_early: false }).eq('id', id);
                }
                
                loadData();
            };

            const restoreCustody = async (id) => {
                if (confirm('ÿ•ÿ±ÿ¨ÿßÿπ ÿßŸÑÿπŸáÿØÿ© ŸÑŸÑŸÜÿ¥ÿ∑ÿ©ÿü')) {
                    await supabase.from('custodies').update({ status: 'active' }).eq('id', id);
                    loadData();
                }
            };

            const deleteCustody = async (id) => {
                if (confirm('ÿ≠ÿ∞ŸÅ ÿßŸÑÿπŸáÿØÿ© ŸÜŸáÿßÿ¶ŸäÿßŸãÿü')) {
                    await supabase.from('custodies').delete().eq('id', id);
                    loadData();
                }
            };

            const deleteExpense = async (id) => {
                if (confirm('ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿµÿ±ŸàŸÅÿü')) {
                    await supabase.from('expenses').delete().eq('id', id);
                    loadData();
                }
            };

            const toggleExpenses = (id) => {
                setExpandedExpenses(prev => ({...prev, [id]: !prev[id]}));
            };

            const highlightText = (text, search) => {
                if (!search) return text;
                const parts = text.toString().split(new RegExp(`(${search})`, 'gi'));
                return parts.map((part, i) => 
                    part.toLowerCase() === search.toLowerCase() 
                        ? <mark key={i}>{part}</mark> 
                        : part
                );
            };

            const getExpenses = (custodyId) => expenses.filter(e => e.custody_id === custodyId);
            const getTotalExpenses = (custodyId) => getExpenses(custodyId).reduce((sum, e) => sum + e.amount, 0);
            const isComplete = (custody) => getTotalExpenses(custody.id) >= custody.amount;

            const applyFilters = (custodiesList) => {
                return custodiesList.filter(custody => {
                    // Search filter
                    if (searchTerm) {
                        const search = searchTerm.toLowerCase();
                        const matchCustody = custody.description.toLowerCase().includes(search) || custody.serial.toString().includes(search);
                        const matchExpense = getExpenses(custody.id).some(exp => 
                            exp.description.toLowerCase().includes(search) || exp.serial.toString().includes(search)
                        );
                        if (!matchCustody && !matchExpense) return false;
                    }
                    
                    // Date filter
                    if (dateFrom && custody.date < dateFrom) return false;
                    if (dateTo && custody.date > dateTo) return false;
                    
                    // Amount filter
                    if (amountMin && custody.amount < parseFloat(amountMin)) return false;
                    if (amountMax && custody.amount > parseFloat(amountMax)) return false;
                    
                    return true;
                });
            };

            const filteredCustodies = applyFilters(custodies);

            const stats = {
                activeTotal: allCustodies.filter(c => c.status === 'active').reduce((s, c) => s + c.amount, 0),
                activeCount: allCustodies.filter(c => c.status === 'active').length,
                clearedTotal: allCustodies.filter(c => c.status === 'cleared').reduce((s, c) => s + c.amount, 0),
                clearedCount: allCustodies.filter(c => c.status === 'cleared').length,
                remaining: allCustodies.filter(c => c.status === 'active').reduce((s, c) => s + (c.amount - getTotalExpenses(c.id)), 0),
                earlyCount: allCustodies.filter(c => c.status === 'cleared' && c.cleared_early).length
            };

            const printReport = () => {
                const printCustodies = filteredCustodies;
                const totalAmount = printCustodies.reduce((s, c) => s + c.amount, 0);
                const totalSpent = printCustodies.reduce((s, c) => s + getTotalExpenses(c.id), 0);
                const totalRemaining = totalAmount - totalSpent;

                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html dir="rtl">
                    <head>
                        <meta charset="UTF-8">
                        <title>ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑÿπŸáÿØ - ${user}</title>
                        <style>
                            body { font-family: 'Segoe UI', Tahoma, Arial; direction: rtl; padding: 20px; }
                            .header { text-align: center; border-bottom: 3px solid #0084ff; padding-bottom: 20px; margin-bottom: 30px; }
                            .header h1 { color: #0084ff; margin: 10px 0; }
                            .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin: 30px 0; }
                            .stat-box { background: #f0f7ff; padding: 15px; border-radius: 8px; text-align: center; }
                            .stat-box .label { font-size: 0.85rem; color: #65676b; }
                            .stat-box .value { font-size: 1.5rem; font-weight: bold; color: #0084ff; margin: 5px 0; }
                            table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                            th, td { padding: 12px; text-align: right; border-bottom: 1px solid #ddd; font-size: 0.9rem; }
                            th { background: #0084ff; color: white; }
                            .footer { margin-top: 40px; text-align: center; color: #65676b; font-size: 0.9rem; }
                            @media print {
                                .no-print { display: none; }
                                @page { margin: 1cm; }
                            }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h1>üìã ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑÿπŸáÿØ</h1>
                            <h2>${user}</h2>
                            <p>${new Date().toLocaleDateString('ar-SA')}</p>
                        </div>
                        
                        <div class="stats">
                            <div class="stat-box">
                                <div class="label">ÿπÿØÿØ ÿßŸÑÿπŸáÿØ</div>
                                <div class="value">${printCustodies.length}</div>
                            </div>
                            <div class="stat-box">
                                <div class="label">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ®ÿßŸÑÿ∫</div>
                                <div class="value">${totalAmount.toFixed(2)}</div>
                                <div class="label">ÿ±.ÿ≥</div>
                            </div>
                            <div class="stat-box">
                                <div class="label">ÿßŸÑŸÖÿµÿ±ŸàŸÅ</div>
                                <div class="value">${totalSpent.toFixed(2)}</div>
                                <div class="label">ÿ±.ÿ≥</div>
                            </div>
                            <div class="stat-box">
                                <div class="label">ÿßŸÑŸÖÿ™ÿ®ŸÇŸä</div>
                                <div class="value">${totalRemaining.toFixed(2)}</div>
                                <div class="label">ÿ±.ÿ≥</div>
                            </div>
                        </div>

                        <table>
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>ÿßŸÑŸàÿµŸÅ</th>
                                    <th>ÿßŸÑÿ™ÿßÿ±ŸäÿÆ</th>
                                    <th>ÿßŸÑŸÖÿ®ŸÑÿ∫</th>
                                    <th>ÿßŸÑŸÖÿµÿ±ŸàŸÅ</th>
                                    <th>ÿßŸÑŸÖÿ™ÿ®ŸÇŸä</th>
                                    <th>ÿßŸÑŸÜÿ≥ÿ®ÿ©</th>
                                    <th>ÿßŸÑÿ≠ÿßŸÑÿ©</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${printCustodies.map((c, i) => {
                                    const spent = getTotalExpenses(c.id);
                                    const remaining = c.amount - spent;
                                    const percentage = (spent / c.amount * 100).toFixed(1);
                                    return `
                                        <tr>
                                            <td>${i + 1}</td>
                                            <td>${c.description}</td>
                                            <td>${c.date}</td>
                                            <td>${c.amount.toFixed(2)}</td>
                                            <td>${spent.toFixed(2)}</td>
                                            <td>${remaining.toFixed(2)}</td>
                                            <td>${percentage}%</td>
                                            <td>${c.status === 'active' ? 'üü¢ ŸÜÿ¥ÿ∑ÿ©' : '‚úÖ ŸÖÿµŸÅÿßÿ©'}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>

                        <div class="footer">
                            <p>ÿ™ŸÖ ÿßŸÑÿ∑ÿ®ÿßÿπÿ© ŸÅŸä: ${new Date().toLocaleString('ar-SA')}</p>
                            <p>ŸÜÿ∏ÿßŸÖ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿπŸáÿØ</p>
                        </div>

                        <button class="no-print" onclick="window.print()" style="position: fixed; top: 20px; left: 20px; padding: 10px 20px; background: #0084ff; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem;">
                            üñ®Ô∏è ÿ∑ÿ®ÿßÿπÿ©
                        </button>
                    </body>
                    </html>
                `);
                printWindow.document.close();
            };

            return (
                <div className="app-container">
                    <div className="top-bar">
                        <button className="btn-back" onClick={() => window.location.href = 'dashboard.html'}>
                            <i className="fas fa-arrow-right"></i>
                        </button>
                        <h2><i className="fas fa-clipboard-list"></i> ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿπŸáÿØ - {user}</h2>
                        <button className="btn-export" onClick={printReport} title="ÿ∑ÿ®ÿßÿπÿ©">
                            <i className="fas fa-print"></i>
                        </button>
                    </div>

                    <div className="stats-row">
                        <div className="stat-box blue">
                            <i className="fas fa-file-invoice-dollar"></i>
                            <div>
                                <small>ÿßŸÑÿπŸáÿØ ÿßŸÑŸÜÿ¥ÿ∑ÿ©</small>
                                <strong>{stats.activeCount}</strong>
                                <span>{stats.activeTotal.toFixed(2)} ÿ±.ÿ≥</span>
                            </div>
                        </div>
                        <div className="stat-box green">
                            <i className="fas fa-check-circle"></i>
                            <div>
                                <small>ÿßŸÑÿπŸáÿØ ÿßŸÑŸÖÿµŸÅÿßÿ©</small>
                                <strong>{stats.clearedCount}</strong>
                                <span>{stats.clearedTotal.toFixed(2)} ÿ±.ÿ≥</span>
                            </div>
                        </div>
                        <div className="stat-box cyan">
                            <i className="fas fa-coins"></i>
                            <div>
                                <small>ÿßŸÑŸÖÿ™ÿ®ŸÇŸä</small>
                                <strong>{stats.remaining.toFixed(2)}</strong>
                                <span>ÿ±.ÿ≥</span>
                            </div>
                        </div>
                        <div className="stat-box orange">
                            <i className="fas fa-wallet"></i>
                            <div>
                                <small>ŸÖÿ≠ŸÅÿ∏ÿ© ÿßŸÑŸÖÿØŸäÿ±</small>
                                <strong>{wallet.toFixed(2)}</strong>
                                <span>(ŸÖÿ±ÿ≠ŸÑ ŸÖŸÜ ÿπŸáÿØ ŸÖÿµŸÅÿßÿ© ŸÖÿ®ŸÉÿ±ÿßŸã)</span>
                            </div>
                        </div>
                    </div>

                    <div className="panel">
                        <h3><i className="fas fa-plus-circle"></i> ÿ•ÿ∂ÿßŸÅÿ© ÿπŸáÿØÿ© ÿ¨ÿØŸäÿØÿ©</h3>
                        <form onSubmit={addCustody} className="neat-form">
                            <div className="row-2">
                                <div>
                                    <label><i className="fas fa-calendar"></i> ÿßŸÑÿ™ÿßÿ±ŸäÿÆ</label>
                                    <input name="date" type="date" defaultValue={new Date().toISOString().split('T')[0]} required />
                                </div>
                                <div>
                                    <label><i className="fas fa-money-bill-wave"></i> ÿßŸÑŸÖÿ®ŸÑÿ∫</label>
                                    <input name="amount" type="number" step="0.01" placeholder="0.00" required />
                                </div>
                            </div>
                            <div>
                                <label><i className="fas fa-align-right"></i> ÿßŸÑŸàÿµŸÅ</label>
                                <input name="desc" placeholder="ŸàÿµŸÅ ÿßŸÑÿπŸáÿØÿ©" required />
                            </div>
                            <div>
                                <label><i className="fas fa-project-diagram"></i> ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)</label>
                                <select name="project_id" onChange={(e) => {
                                    if (e.target.value === 'new') {
                                        setShowQuickProject(true);
                                    } else {
                                        setShowQuickProject(false);
                                        setQuickProjectForm(null);
                                    }
                                }}>
                                    <option value="null">ÿ®ÿØŸàŸÜ ŸÖÿ¥ÿ±Ÿàÿπ</option>
                                    <option value="new">‚ûï ŸÖÿ¥ÿ±Ÿàÿπ ÿ¨ÿØŸäÿØ</option>
                                    {projects.filter(p => p.status === 'active').map(p => (
                                        <option key={p.id} value={p.id}>{p.name}</option>
                                    ))}
                                </select>
                            </div>
                            {showQuickProject && (
                                <div className="quick-project-form">
                                    <input 
                                        type="text" 
                                        placeholder="ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ ÿßŸÑÿ¨ÿØŸäÿØ *" 
                                        value={quickProjectForm?.name || ''}
                                        onChange={(e) => setQuickProjectForm({...quickProjectForm, name: e.target.value})}
                                        required
                                    />
                                    <input 
                                        type="text" 
                                        placeholder="ŸàÿµŸÅ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)" 
                                        value={quickProjectForm?.description || ''}
                                        onChange={(e) => setQuickProjectForm({...quickProjectForm, description: e.target.value})}
                                    />
                                </div>
                            )}
                            {wallet > 0 && (
                                <label className="wallet-option">
                                    <input name="useWallet" type="checkbox" />
                                    <span><i className="fas fa-wallet"></i> ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ŸÖŸÜ ÿßŸÑŸÖÿ≠ŸÅÿ∏ÿ© ({wallet.toFixed(2)} ÿ±.ÿ≥)</span>
                                </label>
                            )}
                            <button type="submit" className="btn-main"><i className="fas fa-save"></i> ÿ•ÿ∂ÿßŸÅÿ©</button>
                        </form>
                    </div>

                    <div className="controls-row">
                        <div className="search-field">
                            <i className="fas fa-search"></i>
                            <input 
                                type="text" 
                                placeholder="ÿ®ÿ≠ÿ´..." 
                                value={searchTerm}
                                onChange={(e) => setSearchTerm(e.target.value)}
                            />
                            {searchTerm && <i className="fas fa-times" onClick={() => setSearchTerm('')}></i>}
                        </div>
                        <button className="btn-filter" onClick={() => setShowFilters(!showFilters)}>
                            <i className="fas fa-filter"></i>
                            {(dateFrom || dateTo || amountMin || amountMax) && <span className="filter-badge">!</span>}
                        </button>
                        <div className="view-toggle">
                            <button 
                                className={viewMode === 'list' ? 'active' : ''} 
                                onClick={() => setViewMode('list')}
                                title="ÿπÿ±ÿ∂ ÿ£ÿ≥ÿ∑ÿ±">
                                <i className="fas fa-list"></i>
                            </button>
                            <button 
                                className={viewMode === 'grid' ? 'active' : ''} 
                                onClick={() => setViewMode('grid')}
                                title="ÿπÿ±ÿ∂ ŸÖÿ±ÿ®ÿπÿßÿ™">
                                <i className="fas fa-th"></i>
                            </button>
                        </div>
                    </div>

                    {showFilters && (
                        <div className="filters-panel">
                            <h4><i className="fas fa-sliders-h"></i> ŸÅŸÑÿßÿ™ÿ± ŸÖÿ™ŸÇÿØŸÖÿ©</h4>
                            <div className="filters-grid">
                                <div>
                                    <label>ŸÖŸÜ ÿ™ÿßÿ±ŸäÿÆ</label>
                                    <input type="date" value={dateFrom} onChange={(e) => setDateFrom(e.target.value)} />
                                </div>
                                <div>
                                    <label>ÿ•ŸÑŸâ ÿ™ÿßÿ±ŸäÿÆ</label>
                                    <input type="date" value={dateTo} onChange={(e) => setDateTo(e.target.value)} />
                                </div>
                                <div>
                                    <label>ÿ£ŸÇŸÑ ŸÖÿ®ŸÑÿ∫</label>
                                    <input type="number" step="0.01" value={amountMin} onChange={(e) => setAmountMin(e.target.value)} placeholder="0.00" />
                                </div>
                                <div>
                                    <label>ÿ£ÿπŸÑŸâ ŸÖÿ®ŸÑÿ∫</label>
                                    <input type="number" step="0.01" value={amountMax} onChange={(e) => setAmountMax(e.target.value)} placeholder="0.00" />
                                </div>
                            </div>
                            <button className="btn-clear-filters" onClick={() => {
                                setDateFrom('');
                                setDateTo('');
                                setAmountMin('');
                                setAmountMax('');
                            }}>
                                <i className="fas fa-times-circle"></i> ŸÖÿ≥ÿ≠ ÿßŸÑŸÅŸÑÿßÿ™ÿ±
                            </button>
                        </div>
                    )}

                    <div className="filter-section">
                        <div className="tab-btns">
                            <button className={tab === 'active' ? 'active' : ''} onClick={() => setTab('active')}>
                                <i className="fas fa-folder-open"></i> ÿßŸÑŸÜÿ¥ÿ∑ÿ© ({stats.activeCount})
                            </button>
                            <button className={tab === 'cleared' ? 'active' : ''} onClick={() => setTab('cleared')}>
                                <i className="fas fa-check-double"></i> ÿßŸÑŸÖÿµŸÅÿßÿ© ({stats.clearedCount})
                            </button>
                        </div>
                        
                        <select value={selectedProject} onChange={(e) => setSelectedProject(e.target.value)} className="project-select">
                            <option value="all">ŸÉŸÑ ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ</option>
                            <option value="unassigned">ÿ®ÿØŸàŸÜ ŸÖÿ¥ÿ±Ÿàÿπ</option>
                            {projects.map(p => (
                                <option key={p.id} value={p.id}>{p.name}</option>
                            ))}
                        </select>

                        {tab === 'cleared' && (
                            <select value={clearedFilter} onChange={(e) => setClearedFilter(e.target.value)} className="clear-filter-select">
                                <option value="all">ÿßŸÑŸÉŸÑ ({stats.clearedCount})</option>
                                <option value="early">ÿßŸÑŸÖÿ®ŸÉÿ±ÿ© ({stats.earlyCount})</option>
                                <option value="complete">ÿßŸÑŸÖŸÉÿ™ŸÖŸÑÿ© ({stats.clearedCount - stats.earlyCount})</option>
                            </select>
                        )}
                    </div>

                    {loading ? (
                        <div className="loader"><i className="fas fa-spinner fa-spin"></i> ÿ™ÿ≠ŸÖŸäŸÑ...</div>
                    ) : filteredCustodies.length === 0 ? (
                        <div className="no-data">
                            <i className="fas fa-inbox"></i>
                            <p>{searchTerm || dateFrom || dateTo || amountMin || amountMax ? 'ŸÑÿß ŸÜÿ™ÿßÿ¶ÿ¨ ŸÑŸÑŸÅŸÑÿßÿ™ÿ±' : 'ŸÑÿß ÿπŸáÿØ'}</p>
                        </div>
                    ) : (
                        <div className={`items-list ${viewMode}`}>
                            {filteredCustodies.map(custody => {
                                const custodyExpenses = getExpenses(custody.id);
                                const total = getTotalExpenses(custody.id);
                                const complete = isComplete(custody);
                                const remaining = custody.amount - total;
                                const percentage = (total / custody.amount * 100).toFixed(0);
                                const isEditing = editingCustody?.id === custody.id;
                                const isExpanded = expandedExpenses[custody.id];
                                const custodyProject = projects.find(p => p.id === custody.project_id);

                                return (
                                    <div key={custody.id} className={`item-box ${complete ? 'done' : ''}`}>
                                        {isEditing ? (
                                            <form onSubmit={updateCustody} className="edit-mode">
                                                <div className="row-2">
                                                    <input name="date" type="date" defaultValue={custody.date} required />
                                                    <input name="amount" type="number" step="0.01" defaultValue={custody.amount} required />
                                                </div>
                                                <input name="desc" defaultValue={custody.description} required />
                                                <div className="row-btns">
                                                    <button type="submit" className="btn-ok"><i className="fas fa-check"></i> ÿ≠ŸÅÿ∏</button>
                                                    <button type="button" className="btn-no" onClick={() => setEditingCustody(null)}>
                                                        <i className="fas fa-times"></i> ÿ•ŸÑÿ∫ÿßÿ°
                                                    </button>
                                                </div>
                                            </form>
                                        ) : (
                                            <>
                                                <div className="item-top">
                                                    <div className="info-section">
                                                        <span className="num">#{highlightText(custody.serial, searchTerm)}</span>
                                                        <h4>{highlightText(custody.description, searchTerm)}</h4>
                                                        <small><i className="far fa-calendar"></i> {custody.date}</small>
                                                        <div className="badges">
                                                            {custody.cleared_early && tab === 'cleared' && (
                                                                <span className="badge-early"><i className="fas fa-bolt"></i> ŸÖÿ®ŸÉÿ±ÿ©</span>
                                                            )}
                                                            {custodyProject && (
                                                                <span className="badge-project"><i className="fas fa-project-diagram"></i> {custodyProject.name}</span>
                                                            )}
                                                        </div>
                                                    </div>
                                                    <div className="action-btns">
                                                        <button className="icon-btn" onClick={() => { setCustodyToAssign(custody); setShowProjectModal(true); }} title="ÿ±ÿ®ÿ∑ ÿ®ŸÖÿ¥ÿ±Ÿàÿπ">
                                                            <i className="fas fa-link"></i>
                                                        </button>
                                                        {tab === 'active' && !complete && (
                                                            <button className="icon-btn clear-btn" onClick={() => clearCustody(custody.id, true)} title="ÿ™ÿµŸÅŸäÿ© ŸÖÿ®ŸÉÿ±ÿ©">
                                                                <i className="fas fa-bolt"></i>
                                                            </button>
                                                        )}
                                                        {tab === 'cleared' && (
                                                            <button className="icon-btn restore-btn" onClick={() => restoreCustody(custody.id)} title="ÿ•ÿ±ÿ¨ÿßÿπ">
                                                                <i className="fas fa-undo"></i>
                                                            </button>
                                                        )}
                                                        <button className="icon-btn edit-btn" onClick={() => setEditingCustody(custody)} title="ÿ™ÿπÿØŸäŸÑ">
                                                            <i className="fas fa-edit"></i>
                                                        </button>
                                                        <button className="icon-btn del-btn" onClick={() => deleteCustody(custody.id)} title="ÿ≠ÿ∞ŸÅ">
                                                            <i className="fas fa-trash"></i>
                                                        </button>
                                                    </div>
                                                </div>

                                                <div className="progress-wrap">
                                                    <div className="bar">
                                                        <div className="fill" style={{width: `${Math.min(percentage, 100)}%`}}></div>
                                                    </div>
                                                    <div className="nums">
                                                        <span>ÿßŸÑŸÖÿµÿ±ŸàŸÅ: {total.toFixed(2)} ({percentage}%)</span>
                                                        <span>ÿßŸÑŸÖÿ™ÿ®ŸÇŸä: {remaining.toFixed(2)}</span>
                                                        <span>ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä: {custody.amount}</span>
                                                    </div>
                                                </div>

                                                {complete && tab === 'active' && (
                                                    <button className="btn-done" onClick={() => clearCustody(custody.id, false)}>
                                                        <i className="fas fa-check-circle"></i> ÿ™ÿµŸÅŸäÿ©
                                                    </button>
                                                )}

                                                {tab === 'active' && (
                                                    <form className="add-expense" onSubmit={(e) => {
                                                        e.preventDefault();
                                                        addExpense(custody.id, e.target.amount.value, e.target.desc.value);
                                                        e.target.reset();
                                                    }}>
                                                        <input name="amount" type="number" step="0.01" placeholder="ÿßŸÑŸÖÿ®ŸÑÿ∫" required />
                                                        <input name="desc" placeholder="ŸàÿµŸÅ" required />
                                                        <button type="submit"><i className="fas fa-plus"></i></button>
                                                    </form>
                                                )}

                                                {custodyExpenses.length > 0 && (
                                                    <div className="expenses-area">
                                                        <div className="sec-title" onClick={() => toggleExpenses(custody.id)}>
                                                            <span>
                                                                <i className="fas fa-receipt"></i> ÿßŸÑŸÖÿµÿ±ŸàŸÅÿßÿ™ ({custodyExpenses.length})
                                                            </span>
                                                            <i className={`fas fa-chevron-${isExpanded ? 'up' : 'down'}`}></i>
                                                        </div>
                                                        {isExpanded && (
                                                            <div className="exp-list">
                                                                {custodyExpenses.map(exp => (
                                                                    <div key={exp.id} className="exp-line">
                                                                        <div className="exp-info">
                                                                            <span className="desc">{highlightText(exp.description, searchTerm)}</span>
                                                                            <span className="num">#{highlightText(exp.serial, searchTerm)}</span>
                                                                        </div>
                                                                        <div className="exp-val">
                                                                            <strong>{exp.amount} ÿ±.ÿ≥</strong>
                                                                            {tab === 'active' && (
                                                                                <button onClick={() => deleteExpense(exp.id)}>
                                                                                    <i className="fas fa-times"></i>
                                                                                </button>
                                                                            )}
                                                                        </div>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        )}
                                                    </div>
                                                )}
                                            </>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    )}

                    {showProjectModal && custodyToAssign && (
                        <div className="modal-overlay" onClick={() => setShowProjectModal(false)}>
                            <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                                <h3><i className="fas fa-link"></i> ÿ±ÿ®ÿ∑ ÿ®ŸÖÿ¥ÿ±Ÿàÿπ</h3>
                                <p>ÿßŸÑÿπŸáÿØÿ©: <strong>{custodyToAssign.description}</strong></p>
                                <div className="project-list">
                                    <div className="project-option" onClick={() => assignToProject(custodyToAssign.id, 'null')}>
                                        <i className="fas fa-times-circle"></i>
                                        <span>ÿ•ÿ≤ÿßŸÑÿ© ŸÖŸÜ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ</span>
                                    </div>
                                    {projects.filter(p => p.status === 'active').map(p => (
                                        <div key={p.id} className="project-option" onClick={() => assignToProject(custodyToAssign.id, p.id)}>
                                            <i className="fas fa-project-diagram"></i>
                                            <span>{p.name}</span>
                                        </div>
                                    ))}
                                </div>
                                <button className="btn-no" onClick={() => setShowProjectModal(false)}>
                                    <i className="fas fa-times"></i> ÿ•ŸÑÿ∫ÿßÿ°
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        ReactDOM.render(<CustodyApp />, document.getElementById('root'));
    </script>
</body>
</html>
