<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù‡Ø¯</title>
    <link rel="stylesheet" href="style.css">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;
        const user = localStorage.getItem('currentUser');
        if (!user) window.location.href = 'index.html';

        const supabase = window.supabase.createClient(
            'https://opyuncxyjdqxawddhdjn.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9weXVuY3h5amRxeGF3ZGRoZGpuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyOTkyNjIsImV4cCI6MjA4MTg3NTI2Mn0.BFObQBOTaUCWktaaCGNBbm_UQ98j4GG9QXz_cOywz0M'
        );

        function CustodyApp() {
            const [custodies, setCustodies] = useState([]);
            const [allCustodies, setAllCustodies] = useState([]);
            const [expenses, setExpenses] = useState([]);
            const [tab, setTab] = useState('active');
            const [loading, setLoading] = useState(false);
            const [wallet, setWallet] = useState(0);

            useEffect(() => { loadData(); }, [tab]);

            const loadData = async () => {
                setLoading(true);
                const { data: c } = await supabase.from('custodies').select('*').eq('username', user).eq('status', tab).order('date', { ascending: false });
                const { data: all } = await supabase.from('custodies').select('*').eq('username', user);
                const { data: e } = await supabase.from('expenses').select('*');
                const { data: w } = await supabase.from('wallets').select('*').eq('username', user).single();
                
                setCustodies(c || []);
                setAllCustodies(all || []);
                setExpenses(e || []);
                setWallet(w?.amount || 0);
                setLoading(false);
            };

            const addCustody = async (e) => {
                e.preventDefault();
                const form = e.target;
                const useWallet = form.useWallet?.checked || false;
                const amount = parseFloat(form.amount.value);
                
                if (useWallet && wallet < amount) {
                    alert('Ø§Ù„Ù…Ø¨Ù„Øº ÙÙŠ Ø§Ù„Ù…Ø­ÙØ¸Ø© ØºÙŠØ± ÙƒØ§ÙÙŠ!');
                    return;
                }
                
                await supabase.from('custodies').insert({
                    username: user, serial: Date.now(), date: form.date.value,
                    amount: amount, description: form.desc.value, status: 'active'
                });
                
                if (useWallet) {
                    await updateWallet(-amount);
                }
                
                form.reset(); 
                form.date.value = new Date().toISOString().split('T')[0];
                loadData();
            };

            const updateWallet = async (amount) => {
                const newAmount = wallet + amount;
                const { data: existing } = await supabase.from('wallets').select('*').eq('username', user).single();
                
                if (existing) {
                    await supabase.from('wallets').update({ amount: newAmount }).eq('username', user);
                } else {
                    await supabase.from('wallets').insert({ username: user, amount: newAmount });
                }
                setWallet(newAmount);
            };

            const addExpense = async (custodyId, amount, desc) => {
                const custody = custodies.find(c => c.id === custodyId);
                const currentTotal = getTotalExpenses(custodyId);
                const newTotal = currentTotal + parseFloat(amount);
                
                if (newTotal > custody.amount) {
                    alert(`âš ï¸ ØªØ­Ø°ÙŠØ±!\nÙ…Ø¨Ù„Øº Ø§Ù„Ù…ØµØ±ÙˆÙ ÙŠØªØ¬Ø§ÙˆØ² Ù…Ø¨Ù„Øº Ø§Ù„Ø¹Ù‡Ø¯Ø©\n\nØ§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${(custody.amount - currentTotal).toFixed(2)} Ø±.Ø³\nØ§Ù„Ù…Ø·Ù„ÙˆØ¨: ${amount} Ø±.Ø³`);
                    return;
                }
                
                await supabase.from('expenses').insert({
                    custody_id: custodyId, serial: Date.now(), amount: parseFloat(amount), description: desc
                });
                loadData();
            };

            const clearCustody = async (id, early = false) => {
                const custody = allCustodies.find(c => c.id === id);
                const remaining = custody.amount - getTotalExpenses(id);
                
                if (early && remaining > 0) {
                    if (!confirm(`ØªØµÙÙŠØ© Ù…Ø¨ÙƒØ±Ø© Ù„Ù„Ø¹Ù‡Ø¯Ø©\nØ§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${remaining.toFixed(2)} Ø±.Ø³ Ø³ÙŠØ¶Ø§Ù Ø¥Ù„Ù‰ Ù…Ø­ÙØ¸ØªÙƒ\nÙ‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ`)) {
                        return;
                    }
                    await updateWallet(remaining);
                } else if (!early) {
                    if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØµÙÙŠØ© Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù‡Ø¯Ø©ØŸ')) {
                        return;
                    }
                }
                
                await supabase.from('custodies').update({ status: 'cleared' }).eq('id', id);
                loadData();
            };

            const deleteCustody = async (id) => {
                if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù‡Ø¯Ø©ØŸ (Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©)')) {
                    await supabase.from('custodies').delete().eq('id', id);
                    loadData();
                }
            };

            const deleteExpense = async (id) => {
                if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ØµØ±ÙˆÙØŸ')) {
                    await supabase.from('expenses').delete().eq('id', id);
                    loadData();
                }
            };

            const getExpenses = (custodyId) => expenses.filter(e => e.custody_id === custodyId);
            const getTotalExpenses = (custodyId) => getExpenses(custodyId).reduce((sum, e) => sum + e.amount, 0);
            const isComplete = (custody) => getTotalExpenses(custody.id) >= custody.amount;

            const stats = {
                activeTotal: allCustodies.filter(c => c.status === 'active').reduce((s, c) => s + c.amount, 0),
                activeCount: allCustodies.filter(c => c.status === 'active').length,
                clearedTotal: allCustodies.filter(c => c.status === 'cleared').reduce((s, c) => s + c.amount, 0),
                clearedCount: allCustodies.filter(c => c.status === 'cleared').length,
                remaining: allCustodies.filter(c => c.status === 'active').reduce((s, c) => s + (c.amount - getTotalExpenses(c.id)), 0)
            };

            return (
                <div className="container">
                    <div className="header">
                        <button className="btn" onClick={() => window.location.href = 'dashboard.html'}>â† Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
                        <h2>ğŸ“‹ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù‡Ø¯ - {user}</h2>
                    </div>

                    <div className="stats-container">
                        <div className="stat-card active">
                            <div className="stat-label">Ø§Ù„Ø¹Ù‡Ø¯ Ø§Ù„Ù†Ø´Ø·Ø©</div>
                            <div className="stat-value">{stats.activeCount}</div>
                            <div className="stat-amount">{stats.activeTotal.toFixed(2)} Ø±.Ø³</div>
                        </div>
                        <div className="stat-card cleared">
                            <div className="stat-label">Ø§Ù„Ø¹Ù‡Ø¯ Ø§Ù„Ù…ØµÙØ§Ø©</div>
                            <div className="stat-value">{stats.clearedCount}</div>
                            <div className="stat-amount">{stats.clearedTotal.toFixed(2)} Ø±.Ø³</div>
                        </div>
                        <div className="stat-card remaining">
                            <div className="stat-label">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</div>
                            <div className="stat-value">ğŸ’°</div>
                            <div className="stat-amount">{stats.remaining.toFixed(2)} Ø±.Ø³</div>
                        </div>
                        <div className="stat-card wallet">
                            <div className="stat-label">Ù…Ø­ÙØ¸Ø© Ø§Ù„Ù…Ø¯ÙŠØ±</div>
                            <div className="stat-value">ğŸ‘›</div>
                            <div className="stat-amount">{wallet.toFixed(2)} Ø±.Ø³</div>
                        </div>
                    </div>

                    <div className="form-card">
                        <h3>â• Ø¥Ø¶Ø§ÙØ© Ø¹Ù‡Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>
                        <form onSubmit={addCustody}>
                            <div className="form-row">
                                <input name="date" type="date" defaultValue={new Date().toISOString().split('T')[0]} required />
                                <input name="amount" type="number" step="0.01" placeholder="Ø§Ù„Ù‚ÙŠÙ…Ø© (Ø±.Ø³)" required />
                            </div>
                            <input name="desc" placeholder="ÙˆØµÙ Ø§Ù„Ø¹Ù‡Ø¯Ø©" required />
                            {wallet > 0 && (
                                <div style={{marginTop: 10, padding: 10, background: '#e8f5e9', borderRadius: 8}}>
                                    <label style={{display: 'flex', alignItems: 'center', gap: 10, cursor: 'pointer'}}>
                                        <input name="useWallet" type="checkbox" />
                                        <span>Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø¨Ù„Øº Ù…Ù† Ù…Ø­ÙØ¸Ø© Ø§Ù„Ù…Ø¯ÙŠØ± ({wallet.toFixed(2)} Ø±.Ø³)</span>
                                    </label>
                                </div>
                            )}
                            <button className="btn btn-success" type="submit">Ø¥Ø¶Ø§ÙØ© Ø¹Ù‡Ø¯Ø©</button>
                        </form>
                    </div>

                    <div className="tabs">
                        <button className={`tab ${tab === 'active' ? 'active' : ''}`} onClick={() => setTab('active')}>
                            Ø§Ù„Ø¹Ù‡Ø¯ Ø§Ù„Ù†Ø´Ø·Ø© ({stats.activeCount})
                        </button>
                        <button className={`tab ${tab === 'cleared' ? 'active' : ''}`} onClick={() => setTab('cleared')}>
                            Ø§Ù„Ø¹Ù‡Ø¯ Ø§Ù„Ù…ØµÙØ§Ø© ({stats.clearedCount})
                        </button>
                    </div>

                    {loading ? (
                        <div className="empty-state">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
                    ) : custodies.length === 0 ? (
                        <div className="empty-state">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù‡Ø¯ {tab === 'active' ? 'Ù†Ø´Ø·Ø©' : 'Ù…ØµÙØ§Ø©'} Ø­Ø§Ù„ÙŠØ§Ù‹</div>
                    ) : (
                        <div className="custody-list">
                            {custodies.map(custody => {
                                const custodyExpenses = getExpenses(custody.id);
                                const total = getTotalExpenses(custody.id);
                                const complete = isComplete(custody);
                                const remaining = custody.amount - total;
                                const percentage = (total / custody.amount * 100).toFixed(0);

                                return (
                                    <div key={custody.id} className={`custody-item ${complete ? 'completed' : ''}`}>
                                        <div className="custody-header">
                                            <div className="custody-title">
                                                <span className="serial-badge">#{custody.serial}</span>
                                                <strong>{custody.description}</strong>
                                                {complete && <span className="complete-badge">âœ“ Ù…ÙƒØªÙ…Ù„Ø©</span>}
                                            </div>
                                            <div style={{display: 'flex', gap: '10px', alignItems: 'center'}}>
                                                <div className="custody-date">{custody.date}</div>
                                                <button className="btn-icon btn-danger" onClick={() => deleteCustody(custody.id)} title="Ø­Ø°Ù Ø§Ù„Ø¹Ù‡Ø¯Ø©">ğŸ—‘ï¸</button>
                                            </div>
                                        </div>

                                        <div className="custody-progress">
                                            <div className="progress-bar">
                                                <div className="progress-fill" style={{width: `${Math.min(percentage, 100)}%`}}></div>
                                            </div>
                                            <div className="progress-info">
                                                <span>Ø§Ù„Ù…ØµØ±ÙˆÙ: {total.toFixed(2)} Ø±.Ø³ ({percentage}%)</span>
                                                <span>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: {remaining.toFixed(2)} Ø±.Ø³</span>
                                                <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: {custody.amount} Ø±.Ø³</span>
                                            </div>
                                        </div>

                                        {tab === 'active' && (
                                            <button className="btn btn-success btn-full" onClick={() => clearCustody(custody.id, !complete)}>
                                                {complete ? 'âœ“ ØªØµÙÙŠØ© Ø§Ù„Ø¹Ù‡Ø¯Ø©' : 'âš¡ ØªØµÙÙŠØ© Ù…Ø¨ÙƒØ±Ø© (Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù„Ù„Ù…Ø­ÙØ¸Ø©)'}
                                            </button>
                                        )}

                                        {tab === 'active' && (
                                            <>
                                                <form className="expense-form" onSubmit={(e) => {
                                                    e.preventDefault();
                                                    addExpense(custody.id, e.target.amount.value, e.target.desc.value);
                                                    e.target.reset();
                                                }}>
                                                    <input name="amount" type="number" step="0.01" placeholder="Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…ØµØ±ÙˆÙ" required />
                                                    <input name="desc" placeholder="ÙˆØµÙ Ø§Ù„Ù…ØµØ±ÙˆÙ" required />
                                                    <button className="btn" type="submit">Ø¥Ø¶Ø§ÙØ©</button>
                                                </form>

                                                {custodyExpenses.length > 0 && (
                                                    <div className="expenses-list">
                                                        <h4>Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª ({custodyExpenses.length}):</h4>
                                                        {custodyExpenses.map(exp => (
                                                            <div key={exp.id} className="expense-item">
                                                                <span className="expense-desc">
                                                                    <span className="expense-serial">#{exp.serial}</span>
                                                                    {exp.description}
                                                                </span>
                                                                <div style={{display: 'flex', gap: '10px', alignItems: 'center'}}>
                                                                    <span className="expense-amount">{exp.amount} Ø±.Ø³</span>
                                                                    <button className="btn-icon btn-danger-small" onClick={() => deleteExpense(exp.id)} title="Ø­Ø°Ù Ø§Ù„Ù…ØµØ±ÙˆÙ">ğŸ—‘ï¸</button>
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                )}
                                            </>
                                        )}

                                        {tab === 'cleared' && custodyExpenses.length > 0 && (
                                            <div className="expenses-list">
                                                <h4>Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª ({custodyExpenses.length}):</h4>
                                                {custodyExpenses.map(exp => (
                                                    <div key={exp.id} className="expense-item">
                                                        <span className="expense-desc">
                                                            <span className="expense-serial">#{exp.serial}</span>
                                                            {exp.description}
                                                        </span>
                                                        <span className="expense-amount">{exp.amount} Ø±.Ø³</span>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    )}
                </div>
            );
        }

        ReactDOM.render(<CustodyApp />, document.getElementById('root'));
    </script>
</body>
</html>
