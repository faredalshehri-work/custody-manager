<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø­Ø±Ø± Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø±</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #e0e0e0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        
        .editor-sidebar {
            width: 350px;
            background: white;
            padding: 20px;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        
        .editor-preview {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: Arial, sans-serif;
        }
        
        .form-group textarea {
            min-height: 60px;
            resize: vertical;
        }
        
        .btn-save {
            width: 100%;
            padding: 12px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .btn-cancel {
            width: 100%;
            padding: 12px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        
        .btn-print {
            width: 100%;
            padding: 12px;
            background: #0070C0;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .items-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #ddd;
        }
        
        .item-row {
            background: #f8f9fa;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        
        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .btn-remove-item {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .btn-add-item {
            width: 100%;
            padding: 10px;
            background: #0070C0;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .total-section {
            background: #e8f4f8;
            padding: 15px;
            margin-top: 20px;
            border-radius: 5px;
            border: 2px solid #0070C0;
        }
        
        .total-section h4 {
            margin: 0 0 10px 0;
            color: #0070C0;
        }
        
        .preview-document {
            width: 210mm;
            min-height: 297mm;
            background: white;
            margin: 0 auto;
            padding: 10mm;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
        }
        
        @media print {
            body {
                background: white;
            }
            .editor-sidebar {
                display: none;
            }
            .editor-preview {
                padding: 0;
            }
            .preview-document {
                box-shadow: none;
                width: 100%;
                margin: 0;
                padding: 0;
            }
        }
    </style>
</head>
<body>
    <div class="editor-sidebar">
        <h2>ğŸ“ ØªØ­Ø±ÙŠØ± Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø±</h2>
        
        <div class="form-group">
            <label>Ø±Ù‚Ù… Ø§Ù„Ø¹Ø±Ø¶:</label>
            <input type="text" id="serial_number" readonly style="background:#f0f0f0;">
        </div>
        
        <div class="form-group">
            <label>Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
            <input type="date" id="quote_date">
        </div>
        
        <div class="form-group">
            <label>Ù…Ø¯Ø© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© (ÙŠÙˆÙ…):</label>
            <input type="number" id="validity_days" value="30">
        </div>
        
        <div class="form-group">
            <label>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„:</label>
            <input type="text" id="client_name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„">
        </div>
        
        <div class="form-group">
            <label>Ø§Ù„Ø´Ø±ÙƒØ©:</label>
            <input type="text" id="client_company" placeholder="Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©">
        </div>
        
        <div class="form-group">
            <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</label>
            <input type="text" id="client_phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
        </div>
        
        <div class="form-group">
            <label>Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„:</label>
            <input type="text" id="client_mobile" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„">
        </div>
        
        <div class="form-group">
            <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</label>
            <input type="email" id="client_email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
        </div>
        
        <div class="form-group">
            <label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</label>
            <textarea id="client_address" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„"></textarea>
        </div>
        
        <div class="form-group">
            <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ø±Ø¶:</label>
            <input type="text" id="quote_title" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø±">
        </div>
        
        <div class="items-section">
            <h3>Ø§Ù„Ø¨Ù†ÙˆØ¯ ÙˆØ§Ù„Ø£Ø³Ø¹Ø§Ø±</h3>
            <div id="items-container"></div>
            <button class="btn-add-item" onclick="addItem()">+ Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯ Ø¬Ø¯ÙŠØ¯</button>
        </div>
        
        <div class="total-section">
            <h4>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</h4>
            <p><strong>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ:</strong> <span id="subtotal">0</span> Ø±ÙŠØ§Ù„</p>
            <p><strong>Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© (15%):</strong> <span id="vat">0</span> Ø±ÙŠØ§Ù„</p>
            <p style="font-size: 18px; color: #0070C0;"><strong>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ:</strong> <span id="total">0</span> Ø±ÙŠØ§Ù„</p>
        </div>
        
        <button class="btn-print" onclick="printDocument()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
        <button class="btn-save" onclick="saveQuotation()">ğŸ’¾ Ø­ÙØ¸</button>
        <button class="btn-cancel" onclick="cancelEdit()">âŒ Ø¥Ù„ØºØ§Ø¡</button>
    </div>
    
    <div class="editor-preview" id="preview-area">
        <div class="preview-document" id="document-preview">
            <p style="text-align: center; color: #999; padding: 50px;">
                Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...
            </p>
        </div>
    </div>

    <script>
        const user = localStorage.getItem('currentUser');
        if (!user) window.location.href = 'index.html';

        let items = [];
        let nextSerialNumber = 1;
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ù„Ø¨
        async function loadTemplate() {
            try {
                const response = await fetch('template-volga.html');
                const html = await response.text();
                
                // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙÙ‚Ø· (Ø¨Ø¯ÙˆÙ† Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ­Ø±ÙŠØ±)
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                
                // Ø¥Ø²Ø§Ù„Ø© Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª ÙˆØ§Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©
                const toolbar = doc.querySelector('.toolbar');
                if (toolbar) toolbar.remove();
                
                const sidebar = doc.querySelector('.sidebar');
                if (sidebar) sidebar.remove();
                
                const lineSpacing = doc.getElementById('line-spacing-tools');
                if (lineSpacing) lineSpacing.remove();
                
                // Ø¥Ø²Ø§Ù„Ø© Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø­Ø°Ù
                const deleteButtons = doc.querySelectorAll('.delete-page-btn');
                deleteButtons.forEach(btn => btn.remove());
                
                // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø³ÙƒØ±ÙŠØ¨ØªØ§Øª
                const scripts = doc.querySelectorAll('script');
                scripts.forEach(script => script.remove());
                
                // Ø¬Ø¹Ù„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ØºÙŠØ± Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ­Ø±ÙŠØ±
                const editables = doc.querySelectorAll('[contenteditable]');
                editables.forEach(el => el.removeAttribute('contenteditable'));
                
                return doc.body.innerHTML;
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ù„Ø¨:', error);
                return '<p>Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ù„Ø¨</p>';
            }
        }
        
        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙØ­Ø©
        async function initializePage() {
            // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ³Ù„Ø³Ù„ÙŠ Ø§Ù„ØªØ§Ù„ÙŠ
            const quotations = JSON.parse(localStorage.getItem('quotations') || '[]');
            if (quotations.length > 0) {
                const lastSerial = quotations[quotations.length - 1].serial_number;
                const match = lastSerial.match(/(\d+)$/);
                if (match) {
                    nextSerialNumber = parseInt(match[1]) + 1;
                }
            }
            
            document.getElementById('serial_number').value = `VCT/Q/${new Date().getFullYear()}/${String(nextSerialNumber).padStart(4, '0')}`;
            
            // ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø§Ù„ÙŠ
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('quote_date').value = today;
            
            // Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯ Ø§ÙØªØ±Ø§Ø¶ÙŠ
            addItem();
            
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ù„Ø¨
            const templateHTML = await loadTemplate();
            updatePreview(templateHTML);
        }
        
        // Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯ Ø¬Ø¯ÙŠØ¯
        function addItem() {
            const itemId = Date.now();
            items.push({
                id: itemId,
                description_ar: '',
                description_en: '',
                quantity: 1,
                price: 0
            });
            
            renderItems();
            calculateTotals();
        }
        
        // Ø­Ø°Ù Ø¨Ù†Ø¯
        function removeItem(itemId) {
            items = items.filter(item => item.id !== itemId);
            renderItems();
            calculateTotals();
        }
        
        // Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ù†ÙˆØ¯
        function renderItems() {
            const container = document.getElementById('items-container');
            container.innerHTML = items.map((item, index) => `
                <div class="item-row">
                    <div class="item-header">
                        <strong>Ø§Ù„Ø¨Ù†Ø¯ ${index + 1}</strong>
                        <button class="btn-remove-item" onclick="removeItem(${item.id})">ğŸ—‘ï¸ Ø­Ø°Ù</button>
                    </div>
                    <div class="form-group">
                        <label>Ø§Ù„ÙˆØµÙ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ:</label>
                        <textarea onchange="updateItem(${item.id}, 'description_ar', this.value)">${item.description_ar}</textarea>
                    </div>
                    <div class="form-group">
                        <label>Ø§Ù„ÙˆØµÙ Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ:</label>
                        <textarea onchange="updateItem(${item.id}, 'description_en', this.value)">${item.description_en}</textarea>
                    </div>
                    <div class="form-group">
                        <label>Ø§Ù„ÙƒÙ…ÙŠØ©:</label>
                        <input type="number" value="${item.quantity}" onchange="updateItem(${item.id}, 'quantity', this.value); calculateTotals()">
                    </div>
                    <div class="form-group">
                        <label>Ø§Ù„Ø³Ø¹Ø± (Ø±ÙŠØ§Ù„):</label>
                        <input type="number" value="${item.price}" onchange="updateItem(${item.id}, 'price', this.value); calculateTotals()">
                    </div>
                    <p style="text-align: center; background: #e8f4f8; padding: 8px; border-radius: 3px; margin: 0;">
                        <strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</strong> ${(item.quantity * item.price).toFixed(2)} Ø±ÙŠØ§Ù„
                    </p>
                </div>
            `).join('');
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø¨Ù†Ø¯
        function updateItem(itemId, field, value) {
            const item = items.find(i => i.id === itemId);
            if (item) {
                item[field] = field === 'quantity' || field === 'price' ? parseFloat(value) || 0 : value;
                updatePreview();
            }
        }
        
        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª
        function calculateTotals() {
            const subtotal = items.reduce((sum, item) => sum + (item.quantity * item.price), 0);
            const vat = subtotal * 0.15;
            const total = subtotal + vat;
            
            document.getElementById('subtotal').textContent = subtotal.toFixed(2);
            document.getElementById('vat').textContent = vat.toFixed(2);
            document.getElementById('total').textContent = total.toFixed(2);
            
            updatePreview();
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
        async function updatePreview(templateHTML) {
            if (!templateHTML) {
                const response = await fetch('template-volga.html');
                const html = await response.text();
                
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                
                const toolbar = doc.querySelector('.toolbar');
                if (toolbar) toolbar.remove();
                const sidebar = doc.querySelector('.sidebar');
                if (sidebar) sidebar.remove();
                const lineSpacing = doc.getElementById('line-spacing-tools');
                if (lineSpacing) lineSpacing.remove();
                const deleteButtons = doc.querySelectorAll('.delete-page-btn');
                deleteButtons.forEach(btn => btn.remove());
                const scripts = doc.querySelectorAll('script');
                scripts.forEach(script => script.remove());
                const editables = doc.querySelectorAll('[contenteditable]');
                editables.forEach(el => el.removeAttribute('contenteditable'));
                
                templateHTML = doc.body.innerHTML;
            }
            
            // Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
            let preview = templateHTML;
            preview = preview.replace(/\{\{serial_number\}\}/g, document.getElementById('serial_number').value);
            preview = preview.replace(/\{\{client_name\}\}/g, document.getElementById('client_name').value || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯');
            preview = preview.replace(/\{\{client_company\}\}/g, document.getElementById('client_company').value || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯');
            preview = preview.replace(/\{\{client_phone\}\}/g, document.getElementById('client_phone').value || '');
            preview = preview.replace(/\{\{client_mobile\}\}/g, document.getElementById('client_mobile').value || '');
            preview = preview.replace(/\{\{client_email\}\}/g, document.getElementById('client_email').value || '');
            preview = preview.replace(/\{\{client_address\}\}/g, document.getElementById('client_address').value || '');
            preview = preview.replace(/\{\{quote_title\}\}/g, document.getElementById('quote_title').value || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯');
            
            // Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ®
            const dateValue = document.getElementById('quote_date').value;
            if (dateValue) {
                const [year, month, day] = dateValue.split('-');
                preview = preview.replace(/00\/00\/2026/g, `${day}/${month}/${year}`);
            }
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø¥Ù„Ù‰ Ø§Ù„Ø¬Ø¯ÙˆÙ„
            // Ù‡Ù†Ø§ Ù†Ø­ØªØ§Ø¬ Ù„Ø¥ÙŠØ¬Ø§Ø¯ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙˆØ¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨Ù†ÙˆØ¯
            
            document.getElementById('document-preview').innerHTML = preview;
        }
        
        // Ø­ÙØ¸ Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø±
        function saveQuotation() {
            const quotation = {
                serial_number: document.getElementById('serial_number').value,
                quote_date: document.getElementById('quote_date').value,
                validity_days: document.getElementById('validity_days').value,
                client_name: document.getElementById('client_name').value,
                client_company: document.getElementById('client_company').value,
                client_phone: document.getElementById('client_phone').value,
                client_mobile: document.getElementById('client_mobile').value,
                client_email: document.getElementById('client_email').value,
                client_address: document.getElementById('client_address').value,
                quote_title: document.getElementById('quote_title').value,
                items: items,
                created_at: new Date().toISOString()
            };
            
            const quotations = JSON.parse(localStorage.getItem('quotations') || '[]');
            quotations.push(quotation);
            localStorage.setItem('quotations', JSON.stringify(quotations));
            
            alert('âœ… ØªÙ… Ø­ÙØ¸ Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø± Ø¨Ù†Ø¬Ø§Ø­!');
            window.location.href = 'quotations.html';
        }
        
        // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ­Ø±ÙŠØ±
        function cancelEdit() {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ­Ø±ÙŠØ±ØŸ Ø³ÙŠØªÙ… ÙÙ‚Ø¯Ø§Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª.')) {
                window.location.href = 'quotations.html';
            }
        }
        
        // Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ø³ØªÙ†Ø¯
        function printDocument() {
            window.print();
        }
        
        // ØªÙ‡ÙŠØ¦Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        initializePage();
        
        // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ÙŠÙ† Ù„Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
        ['client_name', 'client_company', 'client_phone', 'client_mobile', 'client_email', 'client_address', 'quote_title', 'quote_date'].forEach(id => {
            document.getElementById(id).addEventListener('input', updatePreview);
        });
    </script>
</body>
</html>
