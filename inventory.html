<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;
        const user = localStorage.getItem('currentUser');
        if (!user) window.location.href = 'index.html';

        const supabase = window.supabase.createClient(
            'https://opyuncxyjdqxawddhdjn.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9weXVuY3h5amRxeGF3ZGRoZGpuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyOTkyNjIsImV4cCI6MjA4MTg3NTI2Mn0.BFObQBOTaUCWktaaCGNBbm_UQ98j4GG9QXz_cOywz0M'
        );

        function InventoryApp() {
            const [view, setView] = useState('categories'); // categories, category-detail
            const [viewMode, setViewMode] = useState(localStorage.getItem('invViewMode') || 'grid');
            const [selectedCategory, setSelectedCategory] = useState(null);
            const [contentTab, setContentTab] = useState('materials'); // materials, products
            
            const [categories, setCategories] = useState([]);
            const [materials, setMaterials] = useState([]);
            const [products, setProducts] = useState([]);
            const [productMaterials, setProductMaterials] = useState([]);
            
            const [searchTerm, setSearchTerm] = useState('');
            const [searchType, setSearchType] = useState('all'); // all, materials, products
            const [searchCategory, setSearchCategory] = useState('all');
            
            // Modals
            const [showCategoryModal, setShowCategoryModal] = useState(false);
            const [showMaterialModal, setShowMaterialModal] = useState(false);
            const [showProductModal, setShowProductModal] = useState(false);
            const [showAddMaterialToProduct, setShowAddMaterialToProduct] = useState(false);
            
            const [editingCategory, setEditingCategory] = useState(null);
            const [editingMaterial, setEditingMaterial] = useState(null);
            const [editingProduct, setEditingProduct] = useState(null);
            const [currentProduct, setCurrentProduct] = useState(null);

            useEffect(() => { loadData(); }, []);
            useEffect(() => { localStorage.setItem('invViewMode', viewMode); }, [viewMode]);

            const loadData = async () => {
                const [c, m, p, pm] = await Promise.all([
                    supabase.from('inventory_categories').select('*').eq('username', user).order('created_at', { ascending: false }),
                    supabase.from('inventory_materials').select('*').eq('username', user).order('created_at', { ascending: false }),
                    supabase.from('inventory_products').select('*').eq('username', user).order('created_at', { ascending: false }),
                    supabase.from('product_materials').select('*')
                ]);
                
                setCategories(c.data || []);
                setMaterials(m.data || []);
                setProducts(p.data || []);
                setProductMaterials(pm.data || []);
            };

            // Categories
            const addCategory = async (e) => {
                e.preventDefault();
                const form = e.target;
                
                if (editingCategory) {
                    await supabase.from('inventory_categories').update({
                        name: form.name.value,
                        description: form.description.value,
                        image_url: form.image_url.value
                    }).eq('id', editingCategory.id);
                } else {
                    await supabase.from('inventory_categories').insert({
                        username: user,
                        name: form.name.value,
                        description: form.description.value,
                        image_url: form.image_url.value
                    });
                }
                
                form.reset();
                setShowCategoryModal(false);
                setEditingCategory(null);
                loadData();
            };

            const deleteCategory = async (id) => {
                if (confirm('ÿ≠ÿ∞ŸÅ ÿßŸÑŸÇÿ≥ŸÖÿü (ÿ≥Ÿäÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸàÿßÿØ ŸàÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑŸÖÿ±ÿ™ÿ®ÿ∑ÿ©)')) {
                    await supabase.from('inventory_categories').delete().eq('id', id);
                    if (selectedCategory?.id === id) {
                        setView('categories');
                        setSelectedCategory(null);
                    }
                    loadData();
                }
            };

            // Materials
            const addMaterial = async (e) => {
                e.preventDefault();
                const form = e.target;
                const categoryId = selectedCategory?.id || parseInt(form.category_id.value);
                
                if (editingMaterial) {
                    await supabase.from('inventory_materials').update({
                        category_id: categoryId,
                        name: form.name.value,
                        description: form.description.value,
                        price: parseFloat(form.price.value),
                        image_url: form.image_url.value
                    }).eq('id', editingMaterial.id);
                } else {
                    await supabase.from('inventory_materials').insert({
                        username: user,
                        category_id: categoryId,
                        name: form.name.value,
                        description: form.description.value,
                        price: parseFloat(form.price.value),
                        image_url: form.image_url.value
                    });
                }
                
                form.reset();
                setShowMaterialModal(false);
                setEditingMaterial(null);
                loadData();
            };

            const deleteMaterial = async (id) => {
                if (confirm('ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿßÿØÿ©ÿü')) {
                    await supabase.from('inventory_materials').delete().eq('id', id);
                    loadData();
                }
            };

            // Products
            const addProduct = async (e) => {
                e.preventDefault();
                const form = e.target;
                const categoryId = selectedCategory?.id || parseInt(form.category_id.value);
                
                if (editingProduct) {
                    await supabase.from('inventory_products').update({
                        category_id: categoryId,
                        name: form.name.value,
                        description: form.description.value,
                        selling_price: parseFloat(form.selling_price.value),
                        image_url: form.image_url.value
                    }).eq('id', editingProduct.id);
                } else {
                    await supabase.from('inventory_products').insert({
                        username: user,
                        category_id: categoryId,
                        name: form.name.value,
                        description: form.description.value,
                        selling_price: parseFloat(form.selling_price.value),
                        image_url: form.image_url.value
                    });
                }
                
                form.reset();
                setShowProductModal(false);
                setEditingProduct(null);
                loadData();
            };

            const deleteProduct = async (id) => {
                if (confirm('ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿü')) {
                    await supabase.from('inventory_products').delete().eq('id', id);
                    loadData();
                }
            };

            // Product Materials
            const addMaterialToProduct = async (e) => {
                e.preventDefault();
                const form = e.target;
                const materialId = parseInt(form.material_id.value);
                const quantity = parseFloat(form.quantity.value);
                
                const { data: existing } = await supabase.from('product_materials')
                    .select('*')
                    .eq('product_id', currentProduct.id)
                    .eq('material_id', materialId)
                    .single();

                if (existing) {
                    await supabase.from('product_materials').update({
                        quantity: existing.quantity + quantity
                    }).eq('id', existing.id);
                } else {
                    await supabase.from('product_materials').insert({
                        product_id: currentProduct.id,
                        material_id: materialId,
                        quantity: quantity
                    });
                }
                
                form.reset();
                setShowAddMaterialToProduct(false);
                loadData();
            };

            const updateMaterialQuantity = async (id, quantity) => {
                await supabase.from('product_materials').update({ quantity: parseFloat(quantity) }).eq('id', id);
                loadData();
            };

            const removeMaterialFromProduct = async (id) => {
                if (confirm('ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑŸÖÿßÿØÿ© ŸÖŸÜ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿü')) {
                    await supabase.from('product_materials').delete().eq('id', id);
                    loadData();
                }
            };

            // Calculations
            const getProductCost = (productId) => {
                const pms = productMaterials.filter(pm => pm.product_id === productId);
                return pms.reduce((sum, pm) => {
                    const material = materials.find(m => m.id === pm.material_id);
                    return sum + (material ? material.price * pm.quantity : 0);
                }, 0);
            };

            const getProductMaterials = (productId) => {
                return productMaterials.filter(pm => pm.product_id === productId);
            };

            const getCategoryName = (categoryId) => {
                const cat = categories.find(c => c.id === categoryId);
                return cat ? cat.name : 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ';
            };

            const getCategoryImage = (categoryId) => {
                const cat = categories.find(c => c.id === categoryId);
                return cat?.image_url || null;
            };

            // Search and Filter
            const getSearchResults = () => {
                let results = [];
                
                // Filter by type
                if (searchType === 'all' || searchType === 'materials') {
                    results = [...results, ...materials.map(m => ({ ...m, type: 'material' }))];
                }
                if (searchType === 'all' || searchType === 'products') {
                    results = [...results, ...products.map(p => ({ ...p, type: 'product' }))];
                }
                
                // Filter by category
                if (searchCategory !== 'all') {
                    results = results.filter(item => item.category_id === parseInt(searchCategory));
                }
                
                // Filter by search term
                if (searchTerm) {
                    const search = searchTerm.toLowerCase();
                    results = results.filter(item => 
                        item.name.toLowerCase().includes(search) || 
                        (item.description && item.description.toLowerCase().includes(search))
                    );
                }
                
                return results;
            };

            const CategoryCard = ({ category }) => {
                const categoryMaterials = materials.filter(m => m.category_id === category.id);
                const categoryProducts = products.filter(p => p.category_id === category.id);
                
                return (
                    <div className="category-card" onClick={() => { setSelectedCategory(category); setView('category-detail'); }}>
                        {category.image_url && (
                            <div className="category-image">
                                <img src={category.image_url} alt={category.name} />
                            </div>
                        )}
                        <div className="category-content">
                            <h3><i className="fas fa-layer-group"></i> {category.name}</h3>
                            {category.description && <p>{category.description}</p>}
                            <div className="category-stats">
                                <span><i className="fas fa-box"></i> {categoryMaterials.length} ŸÖÿßÿØÿ©</span>
                                <span><i className="fas fa-shopping-bag"></i> {categoryProducts.length} ŸÖŸÜÿ™ÿ¨</span>
                            </div>
                        </div>
                        <div className="category-actions" onClick={(e) => e.stopPropagation()}>
                            <button className="icon-btn edit-btn" onClick={() => { setEditingCategory(category); setShowCategoryModal(true); }}>
                                <i className="fas fa-edit"></i>
                            </button>
                            <button className="icon-btn del-btn" onClick={() => deleteCategory(category.id)}>
                                <i className="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                );
            };

            const ItemCard = ({ item }) => {
                const categoryImg = getCategoryImage(item.category_id);
                const categoryName = getCategoryName(item.category_id);
                const isProduct = item.type === 'product';
                
                let cost = 0;
                let profit = 0;
                let profitMargin = 0;
                let productMats = [];
                
                if (isProduct) {
                    cost = getProductCost(item.id);
                    profit = item.selling_price - cost;
                    profitMargin = item.selling_price > 0 ? (profit / item.selling_price * 100).toFixed(1) : 0;
                    productMats = getProductMaterials(item.id);
                }
                
                return (
                    <div className="item-card">
                        {categoryImg && (
                            <div className="category-badge-img">
                                <img src={categoryImg} alt={categoryName} title={categoryName} />
                            </div>
                        )}
                        {item.image_url && (
                            <div className="item-image">
                                <img src={item.image_url} alt={item.name} />
                            </div>
                        )}
                        <div className="item-content">
                            <span className="item-type-badge">{isProduct ? 'üì¶ ŸÖŸÜÿ™ÿ¨' : 'üîß ŸÖÿßÿØÿ©'}</span>
                            <h4>{item.name}</h4>
                            {item.description && <p>{item.description}</p>}
                            
                            {!isProduct ? (
                                <div className="item-price">
                                    <strong>{item.price.toFixed(2)} ÿ±.ÿ≥</strong>
                                </div>
                            ) : (
                                <>
                                    <div className="product-pricing-compact">
                                        <div className="price-line">
                                            <span>ÿ≥ÿπÿ± ÿßŸÑÿ®Ÿäÿπ:</span>
                                            <strong className="sell-price">{item.selling_price.toFixed(2)} ÿ±.ÿ≥</strong>
                                        </div>
                                        <div className="price-line">
                                            <span>ÿßŸÑÿ™ŸÉŸÑŸÅÿ©:</span>
                                            <strong className="cost-price">{cost.toFixed(2)} ÿ±.ÿ≥</strong>
                                        </div>
                                        <div className="price-line profit-line">
                                            <span>ÿßŸÑÿ±ÿ®ÿ≠:</span>
                                            <strong className="profit-price">{profit.toFixed(2)} ÿ±.ÿ≥ ({profitMargin}%)</strong>
                                        </div>
                                    </div>
                                    
                                    {productMats.length > 0 && (
                                        <div className="materials-mini-list">
                                            <small><i className="fas fa-tools"></i> {productMats.length} ŸÖÿßÿØÿ© ŸÖÿ≥ÿ™ÿÆÿØŸÖÿ©</small>
                                        </div>
                                    )}
                                    
                                    <button className="btn-mini" onClick={() => { setCurrentProduct(item); setShowAddMaterialToProduct(true); }}>
                                        <i className="fas fa-plus"></i> ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸàÿßÿØ
                                    </button>
                                </>
                            )}
                        </div>
                        <div className="item-actions">
                            <button className="icon-btn edit-btn" onClick={() => {
                                if (isProduct) {
                                    setEditingProduct(item);
                                    setShowProductModal(true);
                                } else {
                                    setEditingMaterial(item);
                                    setShowMaterialModal(true);
                                }
                            }}>
                                <i className="fas fa-edit"></i>
                            </button>
                            <button className="icon-btn del-btn" onClick={() => {
                                if (isProduct) deleteProduct(item.id);
                                else deleteMaterial(item.id);
                            }}>
                                <i className="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                );
            };

            return (
                <div className="app-container">
                    <div className="top-bar">
                        <button className="btn-back" onClick={() => {
                            if (view === 'category-detail') {
                                setView('categories');
                                setSelectedCategory(null);
                            } else {
                                window.location.href = 'dashboard.html';
                            }
                        }}>
                            <i className="fas fa-arrow-right"></i>
                        </button>
                        <h2>
                            <i className="fas fa-warehouse"></i> 
                            {view === 'categories' ? 'ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ' : selectedCategory?.name}
                            {view === 'categories' && ` - ${user}`}
                        </h2>
                        <button className="btn-export" onClick={() => {
                            if (view === 'categories') setShowCategoryModal(true);
                            else if (contentTab === 'materials') setShowMaterialModal(true);
                            else setShowProductModal(true);
                        }}>
                            <i className="fas fa-plus"></i>
                        </button>
                    </div>

                    {view === 'categories' ? (
                        <>
                            <div className="stats-row">
                                <div className="stat-box blue">
                                    <i className="fas fa-layer-group"></i>
                                    <div>
                                        <small>ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ</small>
                                        <strong>{categories.length}</strong>
                                    </div>
                                </div>
                                <div className="stat-box green">
                                    <i className="fas fa-box"></i>
                                    <div>
                                        <small>ÿßŸÑŸÖŸàÿßÿØ</small>
                                        <strong>{materials.length}</strong>
                                    </div>
                                </div>
                                <div className="stat-box cyan">
                                    <i className="fas fa-shopping-bag"></i>
                                    <div>
                                        <small>ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™</small>
                                        <strong>{products.length}</strong>
                                    </div>
                                </div>
                                <div className="stat-box orange">
                                    <i className="fas fa-dollar-sign"></i>
                                    <div>
                                        <small>ŸÇŸäŸÖÿ© ÿßŸÑŸÖŸàÿßÿØ</small>
                                        <strong>{materials.reduce((s, m) => s + m.price, 0).toFixed(0)}</strong>
                                        <span>ÿ±.ÿ≥</span>
                                    </div>
                                </div>
                            </div>

                            <div className="search-section">
                                <div className="search-controls">
                                    <div className="search-field">
                                        <i className="fas fa-search"></i>
                                        <input 
                                            type="text" 
                                            placeholder="ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ŸÖŸàÿßÿØ ÿ£Ÿà ŸÖŸÜÿ™ÿ¨ÿßÿ™..." 
                                            value={searchTerm}
                                            onChange={(e) => setSearchTerm(e.target.value)}
                                        />
                                        {searchTerm && <i className="fas fa-times" onClick={() => setSearchTerm('')}></i>}
                                    </div>
                                    <select value={searchType} onChange={(e) => setSearchType(e.target.value)} className="search-filter">
                                        <option value="all">ÿßŸÑŸÉŸÑ</option>
                                        <option value="materials">ÿßŸÑŸÖŸàÿßÿØ ŸÅŸÇÿ∑</option>
                                        <option value="products">ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÅŸÇÿ∑</option>
                                    </select>
                                    <select value={searchCategory} onChange={(e) => setSearchCategory(e.target.value)} className="search-filter">
                                        <option value="all">ŸÉŸÑ ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ</option>
                                        {categories.map(c => (
                                            <option key={c.id} value={c.id}>{c.name}</option>
                                        ))}
                                    </select>
                                    <div className="view-toggle">
                                        <button 
                                            className={viewMode === 'list' ? 'active' : ''} 
                                            onClick={() => setViewMode('list')}>
                                            <i className="fas fa-list"></i>
                                        </button>
                                        <button 
                                            className={viewMode === 'grid' ? 'active' : ''} 
                                            onClick={() => setViewMode('grid')}>
                                            <i className="fas fa-th"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            {searchTerm || searchCategory !== 'all' ? (
                                <>
                                    <div className="section-header">
                                        <h3><i className="fas fa-search"></i> ŸÜÿ™ÿßÿ¶ÿ¨ ÿßŸÑÿ®ÿ≠ÿ´ ({getSearchResults().length})</h3>
                                    </div>
                                    {getSearchResults().length === 0 ? (
                                        <div className="no-data">
                                            <i className="fas fa-search"></i>
                                            <p>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÜÿ™ÿßÿ¶ÿ¨</p>
                                        </div>
                                    ) : (
                                        <div className={`items-grid ${viewMode}`}>
                                            {getSearchResults().map(item => (
                                                <ItemCard key={`${item.type}-${item.id}`} item={item} />
                                            ))}
                                        </div>
                                    )}
                                </>
                            ) : (
                                <>
                                    <div className="section-header">
                                        <h3><i className="fas fa-layer-group"></i> ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ</h3>
                                    </div>
                                    {categories.length === 0 ? (
                                        <div className="no-data">
                                            <i className="fas fa-layer-group"></i>
                                            <p>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ£ŸÇÿ≥ÿßŸÖ ÿ≠ÿßŸÑŸäÿßŸã</p>
                                            <button className="btn-main" onClick={() => setShowCategoryModal(true)}>
                                                <i className="fas fa-plus"></i> ÿ•ÿ∂ÿßŸÅÿ© ŸÇÿ≥ŸÖ
                                            </button>
                                        </div>
                                    ) : (
                                        <div className="categories-grid">
                                            {categories.map(cat => (
                                                <CategoryCard key={cat.id} category={cat} />
                                            ))}
                                        </div>
                                    )}
                                </>
                            )}
                        </>
                    ) : (
                        <>
                            <div className="tab-btns" style={{marginBottom: '20px'}}>
                                <button className={contentTab === 'materials' ? 'active' : ''} onClick={() => setContentTab('materials')}>
                                    <i className="fas fa-box"></i> ÿßŸÑŸÖŸàÿßÿØ ({materials.filter(m => m.category_id === selectedCategory.id).length})
                                </button>
                                <button className={contentTab === 'products' ? 'active' : ''} onClick={() => setContentTab('products')}>
                                    <i className="fas fa-shopping-bag"></i> ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ({products.filter(p => p.category_id === selectedCategory.id).length})
                                </button>
                            </div>

                            <div className="controls-row">
                                <div className="search-field">
                                    <i className="fas fa-search"></i>
                                    <input 
                                        type="text" 
                                        placeholder={`ÿ®ÿ≠ÿ´ ŸÅŸä ${contentTab === 'materials' ? 'ÿßŸÑŸÖŸàÿßÿØ' : 'ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™'}...`}
                                        value={searchTerm}
                                        onChange={(e) => setSearchTerm(e.target.value)}
                                    />
                                    {searchTerm && <i className="fas fa-times" onClick={() => setSearchTerm('')}></i>}
                                </div>
                                <div className="view-toggle">
                                    <button 
                                        className={viewMode === 'list' ? 'active' : ''} 
                                        onClick={() => setViewMode('list')}>
                                        <i className="fas fa-list"></i>
                                    </button>
                                    <button 
                                        className={viewMode === 'grid' ? 'active' : ''} 
                                        onClick={() => setViewMode('grid')}>
                                        <i className="fas fa-th"></i>
                                    </button>
                                </div>
                            </div>

                            {contentTab === 'materials' ? (
                                <>
                                    {materials.filter(m => m.category_id === selectedCategory.id && 
                                        (!searchTerm || m.name.toLowerCase().includes(searchTerm.toLowerCase()) || 
                                        (m.description && m.description.toLowerCase().includes(searchTerm.toLowerCase())))).length === 0 ? (
                                        <div className="no-data">
                                            <i className="fas fa-box"></i>
                                            <p>{searchTerm ? 'ŸÑÿß ŸÜÿ™ÿßÿ¶ÿ¨' : 'ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸàÿßÿØ ŸÅŸä Ÿáÿ∞ÿß ÿßŸÑŸÇÿ≥ŸÖ'}</p>
                                            {!searchTerm && (
                                                <button className="btn-main" onClick={() => setShowMaterialModal(true)}>
                                                    <i className="fas fa-plus"></i> ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿßÿØÿ©
                                                </button>
                                            )}
                                        </div>
                                    ) : (
                                        <div className={`items-grid ${viewMode}`}>
                                            {materials.filter(m => m.category_id === selectedCategory.id && 
                                                (!searchTerm || m.name.toLowerCase().includes(searchTerm.toLowerCase()) || 
                                                (m.description && m.description.toLowerCase().includes(searchTerm.toLowerCase())))).map(m => (
                                                <ItemCard key={m.id} item={{ ...m, type: 'material' }} />
                                            ))}
                                        </div>
                                    )}
                                </>
                            ) : (
                                <>
                                    {products.filter(p => p.category_id === selectedCategory.id && 
                                        (!searchTerm || p.name.toLowerCase().includes(searchTerm.toLowerCase()) || 
                                        (p.description && p.description.toLowerCase().includes(searchTerm.toLowerCase())))).length === 0 ? (
                                        <div className="no-data">
                                            <i className="fas fa-shopping-bag"></i>
                                            <p>{searchTerm ? 'ŸÑÿß ŸÜÿ™ÿßÿ¶ÿ¨' : 'ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÅŸä Ÿáÿ∞ÿß ÿßŸÑŸÇÿ≥ŸÖ'}</p>
                                            {!searchTerm && (
                                                <button className="btn-main" onClick={() => setShowProductModal(true)}>
                                                    <i className="fas fa-plus"></i> ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÜÿ™ÿ¨
                                                </button>
                                            )}
                                        </div>
                                    ) : (
                                        <div className={`items-grid ${viewMode}`}>
                                            {products.filter(p => p.category_id === selectedCategory.id && 
                                                (!searchTerm || p.name.toLowerCase().includes(searchTerm.toLowerCase()) || 
                                                (p.description && p.description.toLowerCase().includes(searchTerm.toLowerCase())))).map(p => (
                                                <ItemCard key={p.id} item={{ ...p, type: 'product' }} />
                                            ))}
                                        </div>
                                    )}
                                </>
                            )}
                        </>
                    )}

                    {/* Category Modal */}
                    {showCategoryModal && (
                        <div className="modal-overlay" onClick={() => { setShowCategoryModal(false); setEditingCategory(null); }}>
                            <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                                <h3><i className="fas fa-layer-group"></i> {editingCategory ? 'ÿ™ÿπÿØŸäŸÑ' : 'ÿ•ÿ∂ÿßŸÅÿ©'} ŸÇÿ≥ŸÖ</h3>
                                <form onSubmit={addCategory} className="neat-form">
                                    <div>
                                        <label>ÿßÿ≥ŸÖ ÿßŸÑŸÇÿ≥ŸÖ *</label>
                                        <input name="name" defaultValue={editingCategory?.name} required />
                                    </div>
                                    <div>
                                        <label>ÿßŸÑŸàÿµŸÅ</label>
                                        <textarea name="description" rows="3" defaultValue={editingCategory?.description}></textarea>
                                    </div>
                                    <div>
                                        <label>ÿ±ÿßÿ®ÿ∑ ÿßŸÑÿµŸàÿ±ÿ©</label>
                                        <input name="image_url" type="url" placeholder="https://example.com/image.jpg" defaultValue={editingCategory?.image_url} />
                                    </div>
                                    <div className="row-btns">
                                        <button type="submit" className="btn-ok"><i className="fas fa-save"></i> ÿ≠ŸÅÿ∏</button>
                                        <button type="button" className="btn-no" onClick={() => { setShowCategoryModal(false); setEditingCategory(null); }}>
                                            <i className="fas fa-times"></i> ÿ•ŸÑÿ∫ÿßÿ°
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {/* Material Modal */}
                    {showMaterialModal && (
                        <div className="modal-overlay" onClick={() => { setShowMaterialModal(false); setEditingMaterial(null); }}>
                            <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                                <h3><i className="fas fa-box"></i> {editingMaterial ? 'ÿ™ÿπÿØŸäŸÑ' : 'ÿ•ÿ∂ÿßŸÅÿ©'} ŸÖÿßÿØÿ©</h3>
                                <form onSubmit={addMaterial} className="neat-form">
                                    {!selectedCategory && (
                                        <div>
                                            <label>ÿßŸÑŸÇÿ≥ŸÖ *</label>
                                            <select name="category_id" defaultValue={editingMaterial?.category_id} required>
                                                <option value="">ÿßÿÆÿ™ÿ± ÿßŸÑŸÇÿ≥ŸÖ</option>
                                                {categories.map(c => (
                                                    <option key={c.id} value={c.id}>{c.name}</option>
                                                ))}
                                            </select>
                                        </div>
                                    )}
                                    <div>
                                        <label>ÿßÿ≥ŸÖ ÿßŸÑŸÖÿßÿØÿ© *</label>
                                        <input name="name" defaultValue={editingMaterial?.name} required />
                                    </div>
                                    <div>
                                        <label>ÿßŸÑŸàÿµŸÅ</label>
                                        <textarea name="description" rows="2" defaultValue={editingMaterial?.description}></textarea>
                                    </div>
                                    <div>
                                        <label>ÿßŸÑÿ≥ÿπÿ± (ÿ±.ÿ≥) *</label>
                                        <input name="price" type="number" step="0.01" defaultValue={editingMaterial?.price} required />
                                    </div>
                                    <div>
                                        <label>ÿ±ÿßÿ®ÿ∑ ÿßŸÑÿµŸàÿ±ÿ©</label>
                                        <input name="image_url" type="url" placeholder="https://example.com/image.jpg" defaultValue={editingMaterial?.image_url} />
                                    </div>
                                    <div className="row-btns">
                                        <button type="submit" className="btn-ok"><i className="fas fa-save"></i> ÿ≠ŸÅÿ∏</button>
                                        <button type="button" className="btn-no" onClick={() => { setShowMaterialModal(false); setEditingMaterial(null); }}>
                                            <i className="fas fa-times"></i> ÿ•ŸÑÿ∫ÿßÿ°
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {/* Product Modal */}
                    {showProductModal && (
                        <div className="modal-overlay" onClick={() => { setShowProductModal(false); setEditingProduct(null); }}>
                            <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                                <h3><i className="fas fa-shopping-bag"></i> {editingProduct ? 'ÿ™ÿπÿØŸäŸÑ' : 'ÿ•ÿ∂ÿßŸÅÿ©'} ŸÖŸÜÿ™ÿ¨</h3>
                                <form onSubmit={addProduct} className="neat-form">
                                    {!selectedCategory && (
                                        <div>
                                            <label>ÿßŸÑŸÇÿ≥ŸÖ *</label>
                                            <select name="category_id" defaultValue={editingProduct?.category_id} required>
                                                <option value="">ÿßÿÆÿ™ÿ± ÿßŸÑŸÇÿ≥ŸÖ</option>
                                                {categories.map(c => (
                                                    <option key={c.id} value={c.id}>{c.name}</option>
                                                ))}
                                            </select>
                                        </div>
                                    )}
                                    <div>
                                        <label>ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÜÿ™ÿ¨ *</label>
                                        <input name="name" defaultValue={editingProduct?.name} required />
                                    </div>
                                    <div>
                                        <label>ÿßŸÑŸàÿµŸÅ</label>
                                        <textarea name="description" rows="2" defaultValue={editingProduct?.description}></textarea>
                                    </div>
                                    <div>
                                        <label>ÿ≥ÿπÿ± ÿßŸÑÿ®Ÿäÿπ (ÿ±.ÿ≥) *</label>
                                        <input name="selling_price" type="number" step="0.01" defaultValue={editingProduct?.selling_price} required />
                                    </div>
                                    <div>
                                        <label>ÿ±ÿßÿ®ÿ∑ ÿßŸÑÿµŸàÿ±ÿ©</label>
                                        <input name="image_url" type="url" placeholder="https://example.com/image.jpg" defaultValue={editingProduct?.image_url} />
                                    </div>
                                    <div className="row-btns">
                                        <button type="submit" className="btn-ok"><i className="fas fa-save"></i> ÿ≠ŸÅÿ∏</button>
                                        <button type="button" className="btn-no" onClick={() => { setShowProductModal(false); setEditingProduct(null); }}>
                                            <i className="fas fa-times"></i> ÿ•ŸÑÿ∫ÿßÿ°
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {/* Add Material to Product Modal */}
                    {showAddMaterialToProduct && currentProduct && (
                        <div className="modal-overlay" onClick={() => { setShowAddMaterialToProduct(false); setCurrentProduct(null); }}>
                            <div className="modal-content modal-large" onClick={(e) => e.stopPropagation()}>
                                <h3><i className="fas fa-tools"></i> ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸàÿßÿØ ŸÑŸÑŸÖŸÜÿ™ÿ¨</h3>
                                <p className="product-name-display"><strong>{currentProduct.name}</strong></p>
                                
                                <form onSubmit={addMaterialToProduct} className="neat-form">
                                    <div className="row-2">
                                        <div>
                                            <label>ÿßŸÑŸÖÿßÿØÿ© *</label>
                                            <select name="material_id" required>
                                                <option value="">ÿßÿÆÿ™ÿ± ÿßŸÑŸÖÿßÿØÿ©</option>
                                                {materials.map(m => (
                                                    <option key={m.id} value={m.id}>
                                                        {m.name} - {m.price} ÿ±.ÿ≥ ({getCategoryName(m.category_id)})
                                                    </option>
                                                ))}
                                            </select>
                                        </div>
                                        <div>
                                            <label>ÿßŸÑŸÉŸÖŸäÿ© *</label>
                                            <input name="quantity" type="number" step="0.01" min="0.01" defaultValue="1" required />
                                        </div>
                                    </div>
                                    <button type="submit" className="btn-ok"><i className="fas fa-plus"></i> ÿ•ÿ∂ÿßŸÅÿ©</button>
                                </form>

                                {getProductMaterials(currentProduct.id).length > 0 && (
                                    <>
                                        <h4 style={{marginTop: '20px', marginBottom: '10px'}}>
                                            <i className="fas fa-list"></i> ÿßŸÑŸÖŸàÿßÿØ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖÿ© ÿ≠ÿßŸÑŸäÿßŸã
                                        </h4>
                                        <div className="current-materials-list">
                                            {getProductMaterials(currentProduct.id).map(pm => {
                                                const mat = materials.find(m => m.id === pm.material_id);
                                                if (!mat) return null;
                                                return (
                                                    <div key={pm.id} className="current-material-item">
                                                        <div className="mat-info">
                                                            <strong>{mat.name}</strong>
                                                            <small>{mat.price} ÿ±.ÿ≥ √ó </small>
                                                            <input 
                                                                type="number" 
                                                                step="0.01" 
                                                                min="0.01"
                                                                value={pm.quantity}
                                                                onChange={(e) => updateMaterialQuantity(pm.id, e.target.value)}
                                                                className="qty-input"
                                                            />
                                                            <span className="mat-total">= {(mat.price * pm.quantity).toFixed(2)} ÿ±.ÿ≥</span>
                                                        </div>
                                                        <button className="btn-icon-del" onClick={() => removeMaterialFromProduct(pm.id)}>
                                                            <i className="fas fa-trash"></i>
                                                        </button>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                        <div className="total-cost-display">
                                            <strong>ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ™ŸÉŸÑŸÅÿ©: {getProductCost(currentProduct.id).toFixed(2)} ÿ±.ÿ≥</strong>
                                        </div>
                                    </>
                                )}

                                <button className="btn-no" onClick={() => { setShowAddMaterialToProduct(false); setCurrentProduct(null); }} style={{marginTop: '15px'}}>
                                    <i className="fas fa-check"></i> ÿ™ŸÖ
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        ReactDOM.render(<InventoryApp />, document.getElementById('root'));
    </script>
</body>
</html>
